<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qplay ì¡±ë³´</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color:#333333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 0;
            box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border-radius: 10px;
        }

        .header {
            color: #333333;
            padding: 20px 30px;
            text-align: left;
            border-bottom: 1px solid #ffffff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h2 {
            font-size: 1.5em;
            margin: 0;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 20px;
        }

        .search-section {
            margin-bottom: 20px;
        }

        .search-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-box {
            width: 100%;
            padding: 10px 16px;
            padding-right: 45px;
            font-size: 0.95em;
            border: 1px solid #999;
            border-radius: 8px;
            background: #ffffff;
            color: #000000;
            transition: all 0.3s ease;
            height: 45px;
        }

        .search-box:focus {
            outline: none;
            border-color: #999;
            box-shadow: 0 0 0 2px rgba(153, 153, 153, 0.1);
        }

        .camera-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 20;
            background: none;
            border: none;
            color: #999;
            font-size: 1.2em;
            cursor: pointer;
            padding: 4px 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            pointer-events: auto;
        }

        .camera-btn:hover {
            color: #000000;
        }

        .camera-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .clear-search-btn {
            background: none;
            border: 1px solid #999;
            border-radius: 8px;
            color: #999;
            font-size: 0.9em;
            z-index: 10;
            cursor: pointer;
            padding: 10px 16px;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            white-space: nowrap;
            height: 45px;
        }

        .clear-search-btn:hover {
            color: #000000;
            border-color: #000000;
        }

        .clear-search-btn.show {
            display: flex;
        }

        .search-box::placeholder {
            color: #999999;
        }

        .results-section {
            margin-top: 30px;
        }

        .results-count {
            margin-bottom: 20px;
            color: #666666;
            font-size: 1em;
        }

        .result-item {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-left: 2px solid #000000;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .result-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left-color: #000000;
        }

        .result-question {
            font-size: 1.2em;
            font-weight: 500;
            color: #333333;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .result-sheet {
            margin-bottom: 10px;
        }

        .result-answer {
            font-size: 1.1em;
            color: #ff0000;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 0;
            margin-top: 10px;
            line-height: 1.8;
        }

        .highlight {
            font-weight: bold;
        }

        .result-question .highlight {
            font-weight: 1000;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #666666;
            font-size: 1.2em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #000000;
            font-size: 1.1em;
        }

        .error {
            background: #ffffff;
            color: #000000;
            padding: 15px;
            border-radius: 0;
            margin-top: 20px;
            border: 1px solid #000000;
            border-left: 2px solid #000000;
        }

        .sheet-tag {
            display: inline-block;
            padding: 4px 10px;
            background: #000000;
            color: #ffffff;
            border-radius: 0;
            font-size: 0.85em;
            margin-left: 10px;
            font-weight: 500;
        }

        .category-section {
            margin-bottom: 20px;
        }

        .category-section.active {
            display: block;
        }

        .category-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .category-dropdown {
            width: 220px;
            padding: 10px 16px;
            font-size: 0.95em;
            border: 1px solid #999;
            border-radius: 8px;
            background: #ffffff;
            color: #000000;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23999999' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 35px;
            height: 45px;
        }

        .auto-copy-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }

        .auto-copy-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #000000;
        }

        .auto-copy-checkbox label {
            font-size: 0.95em;
            color: #000000;
            cursor: pointer;
        }

        .result-limit-dropdown {
            width: 100px;
            padding: 10px 16px;
            font-size: 0.95em;
            border: 1px solid #999;
            border-radius: 8px;
            background: #ffffff;
            color: #000000;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23999999' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 35px;
            height: 45px;
        }

        .result-limit-dropdown:focus {
            outline: none;
            border-color: #999;
            box-shadow: 0 0 0 2px rgba(153, 153, 153, 0.1);
        }

        .result-limit-dropdown:hover {
            border-color: #999;
        }

        .load-more-btn {
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            background: #000000;
            color: #ffffff;
            border: none;
            border-radius: 0;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .load-more-btn:hover {
            background: #333333;
        }

        .load-more-btn:active {
            background: #000000;
        }

        .category-dropdown:focus {
            outline: none;
            border-color: #999;
            box-shadow: 0 0 0 2px rgba(153, 153, 153, 0.1);
        }

        .category-dropdown:hover {
            border-color: #999;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #000000;
            color: #ffffff;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 0.9em;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .camera-modal {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: auto;
            height: auto;
            background: transparent;
            z-index: 2000;
            align-items: flex-end;
            justify-content: flex-end;
            pointer-events: none;
        }

        .camera-modal.show {
            display: flex;
        }

        .camera-modal-content {
            background: #ffffff;
            border-radius: 12px;
            padding: 15px;
            max-width: 400px;
            max-height: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            pointer-events: auto;
            position: relative;
        }

        .camera-modal-header {
            width: 100%;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 4px;
            padding: 0;
            margin: -10px -10px 0 0;
            cursor: move;
            user-select: none; /* ë“œë˜ê·¸ ì‹œ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
        }

        /* ë“œë˜ê·¸ ì¤‘ ì‹œê°ì  í”¼ë“œë°± */
        .camera-modal.dragging .camera-modal-content {
            opacity: 0.9;
        }

        .camera-minimize-btn {
            background: none;
            border: none;
            color: #666666;
            font-size: 1.5em;
            cursor: pointer;
            padding: 4px 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            line-height: 1;
            width: 28px;
            height: 28px;
        }

        .camera-minimize-btn:hover {
            color: #000000;
            background: #f0f0f0;
            border-radius: 4px;
        }

        .camera-minimized-controls {
            display: none;
            gap: 8px;
            align-items: center;
            justify-content: center;
        }

        .camera-icon-btn {
            background: #000000;
            border: none;
            color: #ffffff;
            font-size: 1.2em;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
            line-height: 1;
            min-width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .camera-icon-btn:hover {
            background: #333333;
        }

        .camera-modal.minimized .camera-video-container {
            display: none;
        }

        .camera-modal.minimized .camera-controls {
            display: none;
        }

        .camera-modal.minimized .camera-loading {
            display: none;
        }

        .camera-modal.minimized .camera-modal-header {
            display: none;
        }

        .camera-modal.minimized .camera-minimized-controls {
            display: flex;
        }

        .camera-modal.minimized .camera-modal-content {
            padding: 10px;
            max-width: auto;
            max-height: auto;
            min-width: auto;
            width: auto;
        }

        .camera-video-container {
            position: relative;
            width: 100%;
            max-width: 360px;
            background: #000000;
            border-radius: 8px;
            overflow: hidden;
            cursor: crosshair;
        }

        #cameraVideo {
            width: 100%;
            height: auto;
            display: block;
        }

        /* ì˜ì—­ ì„ íƒ ì˜¤ë²„ë ˆì´ */
        .selection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .selection-box {
            position: absolute;
            border: 2px dashed #00ff00;
            background: rgba(0, 255, 0, 0.1);
            pointer-events: none;
            display: none;
        }

        .selection-box.active {
            display: block;
        }

        .camera-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .camera-controls .camera-close-btn {
            display: none;
        }

        .camera-continue-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            user-select: none;
            font-size: 0.9em;
            color: #333;
        }

        .camera-continue-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .camera-continue-checkbox span {
            white-space: nowrap;
        }

        .camera-capture-btn {
            padding: 12px 24px;
            background: #000000;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .camera-capture-btn:hover {
            background: #333333;
        }

        .camera-capture-btn:disabled {
            background: #999999;
            cursor: not-allowed;
        }

        .camera-close-btn {
            padding: 12px 24px;
            background: #999999;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .camera-close-btn:hover {
            background: #666666;
        }

        .camera-loading {
            padding: 20px;
            text-align: center;
            color: #666666;
        }

        /* Toast ê³µì§€ íŒì—… */
        .notice-toast-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .notice-toast-overlay.show {
            display: block;
        }

        .notice-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 16px 20px;
            max-width: 600px;
            width: calc(100% - 40px);
            z-index: 10000;
            display: none;
            flex-direction: column;
            gap: 12px;
            animation: scaleIn 0.3s ease-out;
        }

        .notice-toast.show {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .notice-toast-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .notice-toast-title {
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
            flex: 1;
        }

        .notice-toast-close {
            background: none;
            border: none;
            font-size: 1.5em;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s ease;
            flex-shrink: 0;
        }

        .notice-toast-close:hover {
            color: #333;
        }

        .notice-toast-content {
            color: #666;
            font-size: 0.9em;
            line-height: 1.5;
            white-space: normal;
        }

        .help-btn {
            background: none;
            border: none;
            color: #666666;
            font-size: 0.9em;
            cursor: pointer;
            padding: 8px 12px;
            transition: color 0.3s ease;
            text-decoration: none;
        }

        .help-btn:hover {
            color: #000000;
        }

        /* ì‚¬ìš©ë°©ë²• ëª¨ë‹¬ */
        .help-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .help-modal-overlay.show {
            display: block;
        }

        .help-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 24px 28px;
            max-width: 600px;
            width: calc(100% - 40px);
            max-height: 80vh;
            overflow-y: auto;
            z-index: 10000;
            display: none;
            flex-direction: column;
            gap: 16px;
            animation: scaleIn 0.3s ease-out;
        }

        .help-modal.show {
            display: flex;
        }

        .help-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .help-modal-title {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
            flex: 1;
        }

        .help-modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s ease;
            flex-shrink: 0;
        }

        .help-modal-close:hover {
            color: #333;
        }

        .help-modal-content {
            color: #666;
            font-size: 0.95em;
            line-height: 1.8;
        }

        .help-modal-content ol {
            margin: 0;
            padding-left: 20px;
        }

        .help-modal-content li {
            margin-bottom: 12px;
        }

        .help-modal-content .tip {
            margin-top: 20px;
            padding: 12px 16px;
            background: #f8f8f8;
            border-left: 3px solid #000000;
            border-radius: 4px;
        }

        .help-modal-content .tip strong {
            color: #333;
        }
    </style>
</head>
<body>
    <!-- Toast ê³µì§€ íŒì—… -->
    <div id="noticeToastOverlay" class="notice-toast-overlay"></div>
    <div id="noticeToast" class="notice-toast">
        <div class="notice-toast-header">
            <div class="notice-toast-title">ğŸ“¢ ì—…ë°ì´íŠ¸ ê³µì§€</div>
            <button class="notice-toast-close" id="noticeToastClose" aria-label="ë‹«ê¸°">Ã—</button>
        </div>
        <div class="notice-toast-content" id="noticeToastContent">
            - ìë™ì¡±ë³´ ê²€ìƒ‰ ë¡œì§ ì—…ë°ì´íŠ¸<br>
            - í™”ë©´ ê³µìœ  íŒì—… dragë¡œ ì´ë™ê°€ëŠ¥<br>
            - í™”ë©´ ê³µìœ  íŒì—… ìµœì†Œí™” ê°€ëŠ¥
        </div>
    </div>

    <!-- ì‚¬ìš©ë°©ë²• ëª¨ë‹¬ -->
    <div id="helpModalOverlay" class="help-modal-overlay"></div>
    <div id="helpModal" class="help-modal">
        <div class="help-modal-header">
            <div class="help-modal-title">ğŸ“– ìë™ì¡±ë³´ ì‚¬ìš©ë²•</div>
            <button class="help-modal-close" id="helpModalClose" aria-label="ë‹«ê¸°">Ã—</button>
        </div>
        <div class="help-modal-content">
            <ol>
                <li><strong>ìë™ì¡±ë³´</strong> ì²´í¬ë°•ìŠ¤ë¥¼ í™œì„±í™”í•˜ì„¸ìš”.</li>
                <li>ê²€ìƒ‰ì°½ ì˜† <strong>ì¹´ë©”ë¼ ì•„ì´ì½˜</strong>ì„ í´ë¦­í•˜ì„¸ìš”.</li>
                <li>í™”ë©´ ê³µìœ  ì°½ì—ì„œ <strong>íí”Œë ˆì´ ì°½</strong>ì„ ì„ íƒí•˜ì„¸ìš”.<br>
                    <small style="color: #999;">â€» í¬ë¡¬ ë¸Œë¼ìš°ì €ì˜ í™”ë©´ ê³µìœ  ê¶Œí•œì´ í—ˆìš©ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.</small></li>
                <li>ë¹„ë””ì˜¤ í™”ë©´ì—ì„œ <strong>ë¬¸ì œê°€ í‘œì‹œë˜ëŠ” ì˜ì—­ì„ ë“œë˜ê·¸</strong>í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”.<br>
                    <small style="color: #999;">â€» ê²Œì„ë§ˆë‹¤ ë¬¸ì œ ì˜ì—­ì´ ë‹¤ë¥´ë¯€ë¡œ ì •í™•íˆ ì„ íƒí•´ì£¼ì„¸ìš”.</small></li>
                <li><strong>ìº¡ì²˜ ë²„íŠ¼</strong>ì„ í´ë¦­í•˜ë©´ ìë™ ê²€ìƒ‰ì´ ì‹œì‘ë©ë‹ˆë‹¤.<br>
                    <small style="color: #999;">â€» ê³„ì† ì‚¬ìš©í•˜ë ¤ë©´ 'ì¤‘ë‹¨ì—†ì´' ì²´í¬ë°•ìŠ¤ë¥¼ í™œì„±í™”í•˜ì„¸ìš”.</small></li>
            </ol>
            <div class="tip">
                <strong>ğŸ’¡ Tip:</strong> ê²Œì„ì„ í•˜ì§€ ì•Šì„ ë•ŒëŠ” ì ì‹œ ì¤‘ë‹¨í•´ì£¼ì„¸ìš”. ë¸Œë¼ìš°ì € ì„±ëŠ¥ ì €í•˜ë¡œ í…ìŠ¤íŠ¸ ì¸ì‹ì— ë¶€í•˜ê°€ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h2>ğŸ’¸ê·¸ê¹½ ì¡±ë³´ğŸ’¸</h2>
            <button id="helpBtn" class="help-btn" aria-label="ìë™ì¡±ë³´ ì‚¬ìš©ë²•">ìë™ì¡±ë³´ ì‚¬ìš©ë²•</button>
        </div>

        <div class="content">
            <div class="category-section" id="categorySection">
                <div class="category-controls">
                <select id="categorySelect" class="category-dropdown" disabled>
                    <option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
                    <select id="resultLimitSelect" class="result-limit-dropdown">
                        <option value="10">10ê°œ</option>
                        <option value="30">30ê°œ</option>
                        <option value="50">50ê°œ</option>
                        <option value="100">100ê°œ</option>
                    </select>
                    <div class="auto-copy-checkbox">
                        <input type="checkbox" id="autoCopyCheckbox">
                        <label for="autoCopyCheckbox">ìë™ë³µì‚¬</label>
                    </div>
                    <div class="auto-copy-checkbox">
                        <input type="checkbox" id="autoJokboCheckbox">
                        <label for="autoJokboCheckbox">ìë™ì¡±ë³´</label>
                    </div>
                </div>
            </div>

            <div class="search-section">
                <div class="search-container">
                    <div style="position: relative; flex: 1;">
                        <input 
                            type="text" 
                            id="searchInput" 
                            class="search-box" 
                            placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                            disabled
                        />
                        <button id="cameraBtn" class="camera-btn" title="í™”ë©´ ìº¡ì²˜ë¡œ ë¬¸ì œ ì¸ì‹" disabled>ğŸ“·</button>
                    </div>
                    <button id="clearSearchBtn" class="clear-search-btn" title="ê²€ìƒ‰ì–´ ì§€ìš°ê¸°">ì§€ìš°ê¸°</button>
                </div>
            </div>

            <div class="results-section">
                <div id="results"></div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <div id="cameraModal" class="camera-modal">
        <div class="camera-modal-content">
            <div class="camera-modal-header">
                <button id="cameraMinimizeBtn" class="camera-minimize-btn" title="ìµœì†Œí™”">âˆ’</button>
                <button id="cameraCloseBtnHeader" class="camera-minimize-btn" title="ë‹«ê¸°">Ã—</button>
            </div>
            <div class="camera-video-container">
                <video id="cameraVideo" autoplay playsinline></video>
                <div class="selection-overlay">
                    <div id="selectionBox" class="selection-box"></div>
                </div>
            </div>
            <div class="camera-controls">
                <label class="camera-continue-checkbox">
                    <input type="checkbox" id="cameraContinueCheckbox">
                    <span>ì¤‘ë‹¨ì—†ì´</span>
                </label>
                <button id="cameraCaptureBtn" class="camera-capture-btn">ìº¡ì²˜</button>
                <button id="cameraCloseBtn" class="camera-close-btn">ë‹«ê¸°</button>
            </div>
            <div id="cameraLoading" class="camera-loading" style="display: none;">
                OCR ì²˜ë¦¬ ì¤‘...
            </div>
            <div class="camera-minimized-controls">
                <button id="cameraMaximizeBtn" class="camera-icon-btn" title="ìµœëŒ€í™”">â–¡</button>
            </div>
        </div>
    </div>

    <script>
        // Toast ê³µì§€ íŒì—… ê¸°ëŠ¥
        const noticeToastOverlay = document.getElementById('noticeToastOverlay');
        const noticeToast = document.getElementById('noticeToast');
        const noticeToastClose = document.getElementById('noticeToastClose');
        
        // ê³µì§€ ë²„ì „ (ìƒˆ ê³µì§€ê°€ ìˆìœ¼ë©´ ì´ ë²„ì „ì„ ë³€ê²½í•˜ë©´ ë©ë‹ˆë‹¤)
        const NOTICE_VERSION = '2';
        
        // ê³µì§€ íŒì—… í‘œì‹œ (ë²„ì „ í™•ì¸)
        function showNoticeToast() {
            if (!noticeToast || !noticeToastOverlay) return;
            
            const savedVersion = localStorage.getItem('noticeToastVersion');
            const isClosed = localStorage.getItem('noticeToastClosed') === 'true';
            
            // ë²„ì „ì´ ë‹¤ë¥´ê±°ë‚˜ ë‹«ì§€ ì•Šì•˜ìœ¼ë©´ í‘œì‹œ
            if (savedVersion !== NOTICE_VERSION || !isClosed) {
                noticeToastOverlay.classList.add('show');
                noticeToast.classList.add('show');
            }
        }
        
        // ê³µì§€ íŒì—… ë‹«ê¸°
        function closeNoticeToast() {
            if (noticeToast && noticeToastOverlay) {
                noticeToast.classList.remove('show');
                noticeToastOverlay.classList.remove('show');
                localStorage.setItem('noticeToastClosed', 'true');
                localStorage.setItem('noticeToastVersion', NOTICE_VERSION);
            }
        }
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        if (noticeToastClose) {
            noticeToastClose.addEventListener('click', closeNoticeToast);
        }
        
        // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        if (noticeToastOverlay) {
            noticeToastOverlay.addEventListener('click', closeNoticeToast);
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê³µì§€ í‘œì‹œ
        window.addEventListener('DOMContentLoaded', showNoticeToast);

        let questionsData = [];
        let currentSearchTerm = '';
        let allSheetNames = [];
        let selectedSheet = null; // ë‹¨ì¼ ì„ íƒìœ¼ë¡œ ë³€ê²½
        let autoCopyEnabled = false;
        let autoJokboEnabled = false;
        let maxResults = 10; // ê¸°ë³¸ê°’ 10ê°œ
        let displayedCount = 0;
        let allFilteredResults = [];
        let debounceTimer = null;

        // JSON ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜
        function processJsonData(jsonData) {
            try {
                questionsData = jsonData.data || [];
                allSheetNames = jsonData.metadata?.sheets || [];
                
                // ì‹œíŠ¸ ì´ë¦„ ì¶”ì¶œ (ë°ì´í„°ì—ì„œ ê³ ìœ í•œ ì‹œíŠ¸ ì´ë¦„ ì°¾ê¸°)
                if (allSheetNames.length === 0) {
                    const uniqueSheets = new Set(jsonData.data.map(item => item.sheet));
                    allSheetNames = Array.from(uniqueSheets);
                }
                
                // ì´ˆê¸°í™”: ì²« ë²ˆì§¸ ì‹œíŠ¸ ì„ íƒ
                selectedSheet = allSheetNames.length > 0 ? allSheetNames[0] : null;
                
                // ì¹´í…Œê³ ë¦¬ ì„ íƒ UI ìƒì„±
                createCategoryFilters();
                
                document.getElementById('searchInput').disabled = false;
                document.getElementById('cameraBtn').disabled = false;
                const totalCount = selectedSheet 
                    ? questionsData.filter(item => item.sheet === selectedSheet).length 
                    : questionsData.length;
                document.getElementById('results').innerHTML = 
                    `<div class="results-count">ì´ ${totalCount}ê°œì˜ ë¬¸ì œê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ${selectedSheet ? `(ì¹´í…Œê³ ë¦¬: ${selectedSheet})` : ''} ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</div>`;
            } catch (error) {
                document.getElementById('categorySection').classList.remove('active');
                document.getElementById('results').innerHTML = 
                    `<div class="error">ë°ì´í„°ë¥¼ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
                document.getElementById('searchInput').disabled = true;
            }
        }

        // Excel íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜
        function processExcelFile(fileData) {
            try {
                const data = new Uint8Array(fileData);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // ëª¨ë“  ì‹œíŠ¸ ì½ê¸°
                questionsData = [];
                allSheetNames = workbook.SheetNames;
                
                // ê° ì‹œíŠ¸ë¥¼ ìˆœíšŒí•˜ë©° ë°ì´í„° ì½ê¸°
                allSheetNames.forEach((sheetName, sheetIndex) => {
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    const sheetData = parseExcelData(jsonData, sheetName);
                    
                    // ì‹œíŠ¸ ì´ë¦„ì„ í¬í•¨í•˜ì—¬ ë°ì´í„° ì¶”ê°€
                    questionsData = questionsData.concat(sheetData);
                });
                
                // ì´ˆê¸°í™”: ì²« ë²ˆì§¸ ì‹œíŠ¸ ì„ íƒ
                selectedSheet = allSheetNames.length > 0 ? allSheetNames[0] : null;
                
                // ì¹´í…Œê³ ë¦¬ ì„ íƒ UI ìƒì„±
                createCategoryFilters();
                
                document.getElementById('searchInput').disabled = false;
                document.getElementById('cameraBtn').disabled = false;
                const totalCount = selectedSheet 
                    ? questionsData.filter(item => item.sheet === selectedSheet).length 
                    : questionsData.length;
                document.getElementById('results').innerHTML = 
                    `<div class="results-count">ì´ ${totalCount}ê°œì˜ ë¬¸ì œê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ${selectedSheet ? `(ì¹´í…Œê³ ë¦¬: ${selectedSheet})` : ''} ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</div>`;
            } catch (error) {
                document.getElementById('categorySection').classList.remove('active');
                document.getElementById('results').innerHTML = 
                    `<div class="error">íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
                document.getElementById('searchInput').disabled = true;
            }
        }


        // ê¸°ë³¸ ë°ì´í„° ìë™ ë¡œë“œ í•¨ìˆ˜ (JSON)
        function loadDefaultData() {
            document.getElementById('results').innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...</div>';
            document.getElementById('searchInput').disabled = true;
            
            // ë¨¼ì € JSON íŒŒì¼ì„ ì‹œë„
            fetch('data.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('JSON íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                    return response.json();
                })
                .then(jsonData => {
                    processJsonData(jsonData);
                })
                .catch(jsonError => {
                    console.log('JSON ë¡œë“œ ì‹¤íŒ¨:', jsonError);
                    document.getElementById('results').innerHTML = 
                        `<div class="no-results" style="text-align: center; padding: 40px;">
                            <h3 style="margin-bottom: 20px; color: #000000;">Qplay ì¡±ë³´ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</h3>
                            <p style="font-size: 1.1em; margin-bottom: 15px;">ë°ì´í„° íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                            <p style="color: #666;">data.json íŒŒì¼ì´ í•„ìš”í•œ ìœ„ì¹˜ì— ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
                        </div>`;
                    document.getElementById('searchInput').disabled = true;
                });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ê¸°ë³¸ íŒŒì¼ ë¡œë“œ ì‹œë„
        window.addEventListener('DOMContentLoaded', function() {
            // ë¡œì»¬ ì„œë²„ í™˜ê²½ì¸ì§€ í™•ì¸ (http:// ë˜ëŠ” https://ë¡œ ì‹œì‘í•˜ëŠ”ì§€)
            if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
                // ì›¹ ì„œë²„ í™˜ê²½ì—ì„œëŠ” ìë™ ë¡œë“œ ì‹œë„ (JSON)
                loadDefaultData();
            } else {
                // file:// í”„ë¡œí† ì½œì¸ ê²½ìš° ì•ˆë‚´
                document.getElementById('results').innerHTML = 
                    `<div class="no-results" style="text-align: center; padding: 40px;">
                        <h3 style="margin-bottom: 20px; color: #667eea;">ğŸ“š Qplay ì¡±ë³´ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</h3>
                        <p style="font-size: 1.1em; margin-bottom: 15px;">ë°ì´í„°ë¥¼ ë¡œë“œí•˜ë ¤ë©´ ë¡œì»¬ ì›¹ ì„œë²„ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.</p>
                        <p style="color: #666;">ë¡œì»¬ ì„œë²„ë¥¼ ì‹¤í–‰í•˜ë ¤ë©´ í„°ë¯¸ë„ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:</p>
                        <p style="color: #999; font-size: 0.9em; margin-top: 20px;">ğŸ’¡ <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 4px;">python -m http.server 8000</code></p>
                    </div>`;
            }
        });

        // Excel ë°ì´í„° íŒŒì‹±
        function parseExcelData(jsonData, sheetName) {
            if (!jsonData || jsonData.length === 0) return [];

            const data = [];
            
            // ì²« ë²ˆì§¸ í–‰ì´ í—¤ë”ì¸ì§€ í™•ì¸
            const firstRow = jsonData[0];
            let hasHeader = false;
            let questionCol = 0;
            let answerCol = 1;

            // ìë™ìœ¼ë¡œ ë¬¸ì œ/ë‹µ ì»¬ëŸ¼ ì°¾ê¸°
            if (firstRow && firstRow.length > 0) {
                const headers = firstRow.map(h => String(h || '').toLowerCase());
                
                // í—¤ë”ì—ì„œ ë¬¸ì œ/ë‹µ ì»¬ëŸ¼ ì°¾ê¸°
                const questionKeywords = ['ë¬¸ì œ', 'question', 'ì§ˆë¬¸', 'ë¬¸í•­', 'ë¬¸ì œë‚´ìš©', 'ë¬¸í•­ë‚´ìš©', 'ë‚´ìš©'];
                const answerKeywords = ['ë‹µ', 'answer', 'ì •ë‹µ', 'í•´ë‹µ', 'ë‹µì•ˆ', 'í•´ì„¤', 'ì •ë‹µë‚´ìš©'];
                
                headers.forEach((h, idx) => {
                    if (questionKeywords.some(k => h.includes(k))) {
                        questionCol = idx;
                        hasHeader = true;
                    }
                    if (answerKeywords.some(k => h.includes(k))) {
                        answerCol = idx;
                        hasHeader = true;
                    }
                });

                // í—¤ë”ê°€ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ì—´ì„ ë¬¸ì œ, ë‘ ë²ˆì§¸ ì—´ì„ ë‹µìœ¼ë¡œ ê°„ì£¼
                if (!hasHeader) {
                    questionCol = 0;
                    answerCol = 1;
                }
            }

            // ë°ì´í„° í–‰ ì²˜ë¦¬
            const startRow = hasHeader ? 1 : 0;
            for (let i = startRow; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || row.length === 0) continue;

                const question = String(row[questionCol] || '').trim();
                const answer = String(row[answerCol] || '').trim();

                if (question) {
                    data.push({
                        question: question,
                        answer: answer || 'ë‹µì´ ì—†ìŠµë‹ˆë‹¤.',
                        index: i - startRow + 1,
                        sheet: sheetName || 'ì•Œ ìˆ˜ ì—†ìŒ'
                    });
                }
            }

            return data;
        }

        // Notification í‘œì‹œ í•¨ìˆ˜
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            // 2ì´ˆ í›„ ìë™ìœ¼ë¡œ ì‚¬ë¼ì§€ê¸°
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2000);
        }

        // ìë™ë³µì‚¬ ê¸°ëŠ¥
        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(text).then(() => {
                    showNotification('ë‹µì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
                    return true;
                }).catch(err => {
                    console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                    return false;
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showNotification('ë‹µì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
                    return Promise.resolve(true);
                } catch (err) {
                    document.body.removeChild(textArea);
                    console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                    return Promise.resolve(false);
                }
            }
        }

        // ì¹´ë©”ë¼ ê´€ë ¨ ë³€ìˆ˜
        let cameraStream = null;
        let cameraModal = null;
        let cameraVideo = null;
        let cameraBtn = null;
        let cameraCaptureBtn = null;
        let cameraCloseBtn = null;
        let cameraLoading = null;
        let cameraContinueCheckbox = null;
        let cameraMinimizeBtn = null;
        let cameraMaximizeBtn = null;
        let cameraCloseBtnHeader = null;

        // ë“œë˜ê·¸ ê´€ë ¨ ë³€ìˆ˜
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let modalStartLeft = 0;
        let modalStartTop = 0;

        // ì˜ì—­ ì„ íƒ ê´€ë ¨ ë³€ìˆ˜
        let isSelecting = false;
        let selectionStart = { x: 0, y: 0 };
        let selectionEnd = { x: 0, y: 0 };
        let selectionBox = null;

        // ìë™ ìº¡ì²˜ ê´€ë ¨ ë³€ìˆ˜
        let autoCaptureInterval = null;
        let isAutoCaptureMode = false;
        let lastOCRText = '';
        let savedSelectionRect = null;

        // ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™” í•¨ìˆ˜
        function initEventListeners() {
            // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const autoCopyCheckbox = document.getElementById('autoCopyCheckbox');
            if (autoCopyCheckbox) {
                autoCopyCheckbox.addEventListener('change', function(e) {
                    autoCopyEnabled = e.target.checked;
                });
            }

            // ìë™ì§€ìš°ê¸° ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const autoClearCheckbox = document.getElementById('autoClearCheckbox');
            if (autoClearCheckbox) {
                autoClearCheckbox.addEventListener('change', function(e) {
                    autoClearEnabled = e.target.checked;
                });
            }

            const autoJokboCheckbox = document.getElementById('autoJokboCheckbox');
            if (autoJokboCheckbox) {
                autoJokboCheckbox.addEventListener('change', function(e) {
                    autoJokboEnabled = e.target.checked;
                    // ëª¨ë“œ ë³€ê²½ ì‹œ ê²€ìƒ‰ ì¬ì‹¤í–‰
                    displayedCount = 0;
                    performSearch(true);
                });
            }

            // ì¹´ë©”ë¼ ê´€ë ¨ ìš”ì†Œ ì´ˆê¸°í™”
            cameraModal = document.getElementById('cameraModal');
            cameraVideo = document.getElementById('cameraVideo');
            cameraBtn = document.getElementById('cameraBtn');
            cameraCaptureBtn = document.getElementById('cameraCaptureBtn');
            cameraCloseBtn = document.getElementById('cameraCloseBtn');
            cameraContinueCheckbox = document.getElementById('cameraContinueCheckbox');
            cameraLoading = document.getElementById('cameraLoading');
            cameraMinimizeBtn = document.getElementById('cameraMinimizeBtn');
            cameraMaximizeBtn = document.getElementById('cameraMaximizeBtn');
            cameraCloseBtnHeader = document.getElementById('cameraCloseBtnHeader');

            // ì¹´ë©”ë¼ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            if (cameraBtn) {
                cameraBtn.addEventListener('click', function() {
                    openCamera();
                });
            }

            // ì¹´ë©”ë¼ ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            if (cameraCloseBtn) {
                cameraCloseBtn.addEventListener('click', function() {
                    closeCamera();
                });
            }

            // ìµœì†Œí™” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            if (cameraMinimizeBtn) {
                cameraMinimizeBtn.addEventListener('click', function() {
                    toggleMinimize();
                });
            }

            // ìµœëŒ€í™” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            if (cameraMaximizeBtn) {
                cameraMaximizeBtn.addEventListener('click', function() {
                    toggleMinimize();
                });
            }

            // í—¤ë” ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            if (cameraCloseBtnHeader) {
                cameraCloseBtnHeader.addEventListener('click', function() {
                    closeCamera();
                });
            }

            // ì¹´ë©”ë¼ ì¤‘ë‹¨ì—†ì´ ì²´í¬ë°•ìŠ¤ëŠ” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë¶ˆí•„ìš” (ìƒíƒœë§Œ í™•ì¸)

            // ìº¡ì²˜ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            if (cameraCaptureBtn) {
                cameraCaptureBtn.addEventListener('click', function() {
                    if (isAutoCaptureMode) {
                        // ìë™ ëª¨ë“œ ì¤‘ì´ë©´ ì¤‘ì§€
                        stopAutoCapture();
                    } else {
                        // ìˆ˜ë™ ìº¡ì²˜ ì‹œì‘
                        captureAndOCR(false);
                    }
                });
            }

            // result-item í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì´ë²¤íŠ¸ ìœ„ì„)
            const resultsDiv = document.getElementById('results');
            if (resultsDiv) {
                resultsDiv.addEventListener('click', function(e) {
                    const resultItem = e.target.closest('.result-item');
                    if (resultItem && autoCopyEnabled) {
                        const answer = resultItem.getAttribute('data-answer');
                        if (answer) {
                            // HTML ì—”í‹°í‹° ë””ì½”ë”©
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = answer;
                            const decodedAnswer = tempDiv.textContent || tempDiv.innerText || '';
                            copyToClipboard(decodedAnswer);
                        }
                    }
                });
            }

            // ì¶œë ¥ ê°œìˆ˜ ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const resultLimitSelect = document.getElementById('resultLimitSelect');
            if (resultLimitSelect) {
                resultLimitSelect.addEventListener('change', function(e) {
                    maxResults = parseInt(e.target.value, 10);
                    displayedCount = 0; // ë¦¬ì…‹
            performSearch();
        });
            }

            // ì¹´ë©”ë¼ ëª¨ë‹¬ ë“œë˜ê·¸ ê¸°ëŠ¥ ì´ˆê¸°í™”
            initDragFunctionality();
        }

        // ì¹´ë©”ë¼ ëª¨ë‹¬ ë“œë˜ê·¸ ê¸°ëŠ¥ ì´ˆê¸°í™”
        function initDragFunctionality() {
            const header = document.querySelector('.camera-modal-header');
            if (!header || !cameraModal) return;
            
            header.addEventListener('mousedown', (e) => {
                // ë²„íŠ¼ í´ë¦­ì€ ë“œë˜ê·¸ë¡œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
                if (e.target.closest('button')) return;
                
                // ìµœì†Œí™” ìƒíƒœì—ì„œëŠ” ë“œë˜ê·¸ ë¹„í™œì„±í™”
                if (cameraModal.classList.contains('minimized')) return;
                
                isDragging = true;
                const rect = cameraModal.getBoundingClientRect();
                dragStartX = e.clientX;
                dragStartY = e.clientY;
                modalStartLeft = rect.left;
                modalStartTop = rect.top;
                
                cameraModal.classList.add('dragging');
                e.preventDefault();
                e.stopPropagation(); // ë‹¤ë¥¸ ì´ë²¤íŠ¸ì™€ ì¶©ëŒ ë°©ì§€
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const deltaX = e.clientX - dragStartX;
                const deltaY = e.clientY - dragStartY;
                
                const newLeft = modalStartLeft + deltaX;
                const newTop = modalStartTop + deltaY;
                
                // í™”ë©´ ê²½ê³„ ì²´í¬
                const maxLeft = window.innerWidth - cameraModal.offsetWidth;
                const maxTop = window.innerHeight - cameraModal.offsetHeight;
                
                const clampedLeft = Math.max(0, Math.min(newLeft, maxLeft));
                const clampedTop = Math.max(0, Math.min(newTop, maxTop));
                
                cameraModal.style.left = clampedLeft + 'px';
                cameraModal.style.top = clampedTop + 'px';
                cameraModal.style.right = 'auto';
                cameraModal.style.bottom = 'auto';
            });
            
            document.addEventListener('mouseup', (e) => {
                if (isDragging) {
                    isDragging = false;
                    cameraModal.classList.remove('dragging');
                }
            });
        }

        // ì˜ì—­ ì„ íƒ ì´ˆê¸°í™” í•¨ìˆ˜
        function initSelectionArea() {
            selectionBox = document.getElementById('selectionBox');
            const videoContainer = document.querySelector('.camera-video-container');
            
            if (!videoContainer || !selectionBox) return;
            
            // ë§ˆìš°ìŠ¤ ë‹¤ìš´ - ì„ íƒ ì‹œì‘
            videoContainer.addEventListener('mousedown', (e) => {
                if (!cameraStream) return;
                isSelecting = true;
                const rect = videoContainer.getBoundingClientRect();
                selectionStart.x = e.clientX - rect.left;
                selectionStart.y = e.clientY - rect.top;
                selectionBox.style.display = 'block';
                selectionBox.classList.add('active');
            });
            
            // ë§ˆìš°ìŠ¤ ì´ë™ - ì„ íƒ ì˜ì—­ ì—…ë°ì´íŠ¸
            videoContainer.addEventListener('mousemove', (e) => {
                if (!isSelecting || !cameraStream) return;
                const rect = videoContainer.getBoundingClientRect();
                selectionEnd.x = e.clientX - rect.left;
                selectionEnd.y = e.clientY - rect.top;
                
                updateSelectionBox();
            });
            
            // ë§ˆìš°ìŠ¤ ì—… - ì„ íƒ ì¢…ë£Œ
            document.addEventListener('mouseup', () => {
                if (isSelecting) {
                    isSelecting = false;
                }
            });
        }

        // ì„ íƒ ë°•ìŠ¤ ì—…ë°ì´íŠ¸
        function updateSelectionBox() {
            if (!selectionBox) return;
            
            const left = Math.min(selectionStart.x, selectionEnd.x);
            const top = Math.min(selectionStart.y, selectionEnd.y);
            const width = Math.abs(selectionEnd.x - selectionStart.x);
            const height = Math.abs(selectionEnd.y - selectionStart.y);
            
            selectionBox.style.left = left + 'px';
            selectionBox.style.top = top + 'px';
            selectionBox.style.width = width + 'px';
            selectionBox.style.height = height + 'px';
        }

        // ì„ íƒ ì˜ì—­ ì¢Œí‘œë¥¼ ë¹„ë””ì˜¤ ì¢Œí‘œë¡œ ë³€í™˜
        function getSelectionRect() {
            if (!cameraVideo || !selectionBox) return null;
            
            // ìµœì†Œí™” ìƒíƒœ í™•ì¸
            const isMinimized = cameraModal && cameraModal.classList.contains('minimized');
            if (isMinimized) {
                return null; // ìµœì†Œí™” ìƒíƒœì—ì„œëŠ” null ë°˜í™˜í•˜ì—¬ savedSelectionRect ì‚¬ìš©
            }
            
            const videoRect = cameraVideo.getBoundingClientRect();
            const containerRect = selectionBox.parentElement.getBoundingClientRect();
            
            // display: noneì¸ ê²½ìš° width/heightê°€ 0ì´ ë  ìˆ˜ ìˆìŒ
            if (videoRect.width === 0 || videoRect.height === 0) {
                return null;
            }
            
            const scaleX = cameraVideo.videoWidth / videoRect.width;
            const scaleY = cameraVideo.videoHeight / videoRect.height;
            
            // scaleì´ ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš° (NaN, Infinity ë“±)
            if (!isFinite(scaleX) || !isFinite(scaleY)) {
                return null;
            }
            
            const left = Math.min(selectionStart.x, selectionEnd.x);
            const top = Math.min(selectionStart.y, selectionEnd.y);
            const width = Math.abs(selectionEnd.x - selectionStart.x);
            const height = Math.abs(selectionEnd.y - selectionStart.y);
            
            // ì˜ì—­ì´ ë„ˆë¬´ ì‘ìœ¼ë©´ ì „ì²´ í™”ë©´ ì‚¬ìš©
            if (width < 10 || height < 10) {
                return null;
            }
            
            return {
                x: left * scaleX,
                y: top * scaleY,
                width: width * scaleX,
                height: height * scaleY
            };
        }

        // ì¹´ë©”ë¼ ì—´ê¸° í•¨ìˆ˜
        async function openCamera() {
            try {
                // í™”ë©´ ê³µìœ  ê¶Œí•œ í™•ì¸
                if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
                    throw new Error('ì´ ë¸Œë¼ìš°ì €ëŠ” í™”ë©´ ê³µìœ  ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }

                // í™”ë©´ ê³µìœ  ìš”ì²­ (ìŠ¤í¬ë¦° ìº¡ì²˜)
                cameraStream = await navigator.mediaDevices.getDisplayMedia({ 
                    video: {
                        displaySurface: 'browser' // ë¸Œë¼ìš°ì € í™”ë©´ ìº¡ì²˜
                    },
                    audio: false
                });
                cameraVideo.srcObject = cameraStream;
                cameraModal.classList.add('show');
                cameraCaptureBtn.disabled = false;
                
                // ì˜ì—­ ì„ íƒ ì´ˆê¸°í™”
                setTimeout(() => {
                    initSelectionArea();
                }, 100);
                
                // ìŠ¤íŠ¸ë¦¼ì´ ì¢…ë£Œë˜ë©´ ëª¨ë‹¬ ë‹«ê¸°
                cameraStream.getVideoTracks()[0].addEventListener('ended', () => {
                    closeCamera();
                });
            } catch (error) {
                console.error('í™”ë©´ ê³µìœ  ì‹¤íŒ¨:', error);
                let errorMessage = 'í™”ë©´ ê³µìœ ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage = 'í™”ë©´ ê³µìœ  ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í™”ë©´ ê³µìœ  ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage = 'í™”ë©´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage = 'í™”ë©´ì´ ë‹¤ë¥¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.';
                }
                
                alert(errorMessage);
            }
        }

        // ì¹´ë©”ë¼ ìµœì†Œí™”/ìµœëŒ€í™” í† ê¸€ í•¨ìˆ˜
        function toggleMinimize() {
            if (!cameraModal) return;
            
            const isMinimized = cameraModal.classList.contains('minimized');
            if (isMinimized) {
                cameraModal.classList.remove('minimized');
            } else {
                cameraModal.classList.add('minimized');
            }
        }

        // ì¹´ë©”ë¼ ë‹«ê¸° í•¨ìˆ˜
        function closeCamera() {
            // ìë™ ìº¡ì²˜ ì¤‘ì§€
            stopAutoCapture();
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            cameraVideo.srcObject = null;
            cameraModal.classList.remove('show');
            cameraModal.classList.remove('minimized');
            cameraLoading.style.display = 'none';
            cameraCaptureBtn.disabled = false;
            cameraCaptureBtn.textContent = 'ìº¡ì²˜';
            
            // ì¤‘ë‹¨ì—†ì´ ì²´í¬ë°•ìŠ¤ ë¦¬ì…‹
            if (cameraContinueCheckbox) {
                cameraContinueCheckbox.checked = false;
            }
            
            // ì„ íƒ ì˜ì—­ ë¦¬ì…‹
            if (selectionBox) {
                selectionBox.style.display = 'none';
                selectionBox.classList.remove('active');
            }
            isSelecting = false;
            lastOCRText = '';
            savedSelectionRect = null;
            
            // ë“œë˜ê·¸ ìœ„ì¹˜ ë¦¬ì…‹
            isDragging = false;
            cameraModal.classList.remove('dragging');
            cameraModal.style.left = '';
            cameraModal.style.top = '';
            cameraModal.style.right = '20px';
            cameraModal.style.bottom = '20px';
        }


        // ìë™ ìº¡ì²˜ ì‹œì‘
        function startAutoCapture() {
            if (isAutoCaptureMode) return;
            
            isAutoCaptureMode = true;
            cameraCaptureBtn.textContent = 'ìë™ ìº¡ì²˜ ì¤‘...';
            cameraCaptureBtn.disabled = true;
            
            // 2ì´ˆë§ˆë‹¤ ìë™ ìº¡ì²˜
            autoCaptureInterval = setInterval(() => {
                if (cameraStream && isAutoCaptureMode) {
                    captureAndOCR(true);
                }
            }, 2000); // 2ì´ˆ ê°„ê²©
        }

        // ìë™ ìº¡ì²˜ ì¤‘ì§€
        function stopAutoCapture() {
            if (!isAutoCaptureMode) return;
            
            isAutoCaptureMode = false;
            if (autoCaptureInterval) {
                clearInterval(autoCaptureInterval);
                autoCaptureInterval = null;
            }
            cameraCaptureBtn.textContent = 'ìº¡ì²˜';
            cameraCaptureBtn.disabled = false;
        }

        // ì´ë¯¸ì§€ ìº¡ì²˜ ë° OCR ì²˜ë¦¬ í•¨ìˆ˜
        async function captureAndOCR(isAutoMode = false) {
            if (!cameraStream) return;

            try {
                if (!isAutoMode) {
                    cameraCaptureBtn.disabled = true;
                }
                // OCR ì²˜ë¦¬ ì¤‘ í…ìŠ¤íŠ¸ ìˆ¨ê¹€
                // cameraLoading.style.display = 'block';

                // ì„ íƒ ì˜ì—­ ê°€ì ¸ì˜¤ê¸°
                const selectionRect = getSelectionRect();
                
                // ìë™ ëª¨ë“œì´ê³  ì„ íƒ ì˜ì—­ì´ ì—†ìœ¼ë©´ ì €ì¥ëœ ì˜ì—­ ì‚¬ìš©
                const captureRect = isAutoMode && !selectionRect ? savedSelectionRect : selectionRect;
                
                if (!captureRect && !isAutoMode) {
                    alert('ì˜ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    cameraLoading.style.display = 'none';
                    cameraCaptureBtn.disabled = false;
                    return;
                }
                
                // ë¹„ë””ì˜¤ í”„ë ˆì„ì„ ìº”ë²„ìŠ¤ì— ìº¡ì²˜
                const canvas = document.createElement('canvas');
                
                if (captureRect) {
                    // ì„ íƒ ì˜ì—­ë§Œ ìº¡ì²˜
                    canvas.width = captureRect.width;
                    canvas.height = captureRect.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(
                        cameraVideo,
                        captureRect.x, captureRect.y, captureRect.width, captureRect.height,
                        0, 0, captureRect.width, captureRect.height
                    );
                } else {
                    // ì „ì²´ í™”ë©´ ìº¡ì²˜ (ì˜ì—­ ì„ íƒ ì•ˆ í•¨)
                    canvas.width = cameraVideo.videoWidth;
                    canvas.height = cameraVideo.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);
                }

                // ìº”ë²„ìŠ¤ë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜
                const imageData = canvas.toDataURL('image/png');

                // Tesseract.jsë¡œ OCR ìˆ˜í–‰ (í•œêµ­ì–´ + ì˜ì–´)
                const { data: { text } } = await Tesseract.recognize(imageData, 'kor+eng', {
                    logger: m => {
                        // OCR ì²˜ë¦¬ ì¤‘ ì§„í–‰ë¥  í‘œì‹œ ìˆ¨ê¹€
                    // if (m.status === 'recognizing text' && !isAutoMode) {
                    //     cameraLoading.textContent = `OCR ì²˜ë¦¬ ì¤‘... ${Math.round(m.progress * 100)}%`;
                    // }
                    },
                    // OCR ì •í™•ë„ í–¥ìƒì„ ìœ„í•œ ì˜µì…˜
                    tessedit_pageseg_mode: '6' // ë‹¨ì¼ í…ìŠ¤íŠ¸ ë¸”ë¡ìœ¼ë¡œ ì¸ì‹
                });

                // í…ìŠ¤íŠ¸ ì •ë¦¬
                let cleanedText = text.trim().replace(/\s+/g, ' ').replace(/\n/g, ' ');
                
                // ë¬¸ì œë§Œ ì¶”ì¶œ (OCR ê²°ê³¼ì—ì„œ ë¬¸ì œ ë¶€ë¶„ë§Œ ì¶”ì¶œ)
                cleanedText = extractQuestion(cleanedText);
                
                // ìë™ ëª¨ë“œì¼ ë•Œë§Œ í…ìŠ¤íŠ¸ ë³€ê²½ í™•ì¸
                if (isAutoMode) {
                    // í…ìŠ¤íŠ¸ê°€ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸ (ì¶”ì¶œëœ ë¬¸ì œ ê¸°ì¤€)
                    if (cleanedText && cleanedText.length > 0 && cleanedText !== lastOCRText) {
                        lastOCRText = cleanedText;
                        // ìë™ ê²€ìƒ‰ ìˆ˜í–‰ (ê²€ìƒ‰ì°½ì— ê²€ìƒ‰ì–´ ì…ë ¥)
                        processOCRResult(cleanedText, true);
                    }
                } else {
                    // ìˆ˜ë™ ëª¨ë“œ: ì²« ìº¡ì²˜ ì‹œ ìë™ ëª¨ë“œ ì‹œì‘
                    if (cleanedText && cleanedText.length > 0) {
                        lastOCRText = cleanedText;
                        savedSelectionRect = captureRect;
                        processOCRResult(cleanedText, false);
                        
                        // ìë™ ìº¡ì²˜ ëª¨ë“œ ì‹œì‘ (ë¬¸ì œê°€ ë°”ë€” ë•Œë§ˆë‹¤ ìë™ ìº¡ì²˜)
                        startAutoCapture();
                    }
                }
                
                cameraLoading.style.display = 'none';
                
                if (!isAutoMode) {
                    cameraCaptureBtn.disabled = false;
                }
            } catch (error) {
                console.error('OCR ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                
                if (!isAutoMode) {
                    let errorMessage = 'OCR ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    
                    if (error.message && error.message.includes('language')) {
                        errorMessage = 'OCR ì–¸ì–´ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                    } else if (error.message) {
                        errorMessage = 'OCR ì²˜ë¦¬ ì‹¤íŒ¨: ' + error.message;
                    }
                    
                    alert(errorMessage);
                    cameraLoading.style.display = 'none';
                    cameraLoading.textContent = 'OCR ì²˜ë¦¬ ì¤‘...';
                    cameraCaptureBtn.disabled = false;
                } else {
                    cameraLoading.style.display = 'none';
                }
            }
        }

        // ë¬¸ì œë§Œ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜
        function extractQuestion(text) {
            if (!text) return '';
            
            let cleaned = text.trim();
            
            // 1. ì¹´í…Œê³ ë¦¬ ì •ë³´ ì œê±° (ì˜ˆ: "í´ì„¸ì‚¬ : ê·œë“¤ë ˆì´")
            cleaned = cleaned.replace(/^[^:]*:\s*[^\[]*/g, '');
            
            // 2. ë¬¸ì œ ë²ˆí˜¸ ì œê±° - ë‹¤ì–‘í•œ íŒ¨í„´ ì²˜ë¦¬
            // [ë¬¸ì œ 1], [ë¬¸ì œ1], [1], ë¬¸ì œã€, ë¬¸ì œã€, ë¬¸ì œ:, ë¬¸ì œ ë“±
            cleaned = cleaned.replace(/\[ë¬¸ì œ\s*\d+\]|\[\d+\]|ë¬¸ì œ\s*\d+/g, '');
            cleaned = cleaned.replace(/ë¬¸ì œ[ã€ã€:ï¼š]\s*/g, ''); // ë¬¸ì œã€, ë¬¸ì œã€, ë¬¸ì œ: ì œê±°
            cleaned = cleaned.replace(/^ë¬¸ì œ\s+/g, ''); // ì‹œì‘ ë¶€ë¶„ì˜ "ë¬¸ì œ " ì œê±°
            
            // 3. ë¬¼ìŒí‘œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¬¸ì œì™€ ì„ íƒì§€/ì •ë‹µ ë¶„ë¦¬ (ê°€ì¥ ì¤‘ìš”)
            const questionMarkIndex = cleaned.indexOf('?');
            if (questionMarkIndex !== -1) {
                cleaned = cleaned.substring(0, questionMarkIndex + 1);
            } else {
                // ë¬¼ìŒí‘œê°€ ì—†ìœ¼ë©´ "ì •ë‹µ", "ë‹µ", "í•´ì„¤" ë“±ì˜ í‚¤ì›Œë“œë¡œ ë¶„ë¦¬
                const answerKeywords = ['ì •ë‹µ', 'ë‹µ', 'í•´ì„¤', 'í•´ë‹µ', 'ë‹µì•ˆ', 'ì •ë‹µ:', 'ë‹µ:', 'í•´ì„¤:'];
                for (const keyword of answerKeywords) {
                    const keywordIndex = cleaned.toLowerCase().indexOf(keyword.toLowerCase());
                    if (keywordIndex !== -1) {
                        cleaned = cleaned.substring(0, keywordIndex);
                        break;
                    }
                }
            }
            
            // 4. ì„ íƒì§€ íŒ¨í„´ ì œê±° (ì˜ˆ: "1.2002", "2.2002", "â‘ ", "â‘¡")
            cleaned = cleaned.replace(/\d+\.\s*[^\?]*/g, '');
            cleaned = cleaned.replace(/[â‘ â‘¡â‘¢â‘£â‘¤â‘¥â‘¦â‘§â‘¨â‘©]\s*[^\?]*/g, '');
            
            // 5. ì •ë‹µ ê´€ë ¨ í‚¤ì›Œë“œ ì œê±° (ë¬¼ìŒí‘œ ì´í›„ì— ë‚¨ì•„ìˆì„ ìˆ˜ ìˆëŠ” ê²½ìš°)
            cleaned = cleaned.replace(/ì •ë‹µ.*$/i, '');
            cleaned = cleaned.replace(/ë‹µ.*$/i, '');
            cleaned = cleaned.replace(/í•´ì„¤.*$/i, '');
            
            // 6. ë¶ˆí•„ìš”í•œ ê³µë°± ì •ë¦¬
            cleaned = cleaned.replace(/\s+/g, ' ').trim();
            
            // 7. OCR ì˜¤ë¥˜ ê°œì„  (ì¼ë°˜ì ì¸ íŒ¨í„´)
            cleaned = cleaned.replace(/FIFAEEY/gi, 'FIFA');
            cleaned = cleaned.replace(/ì›”ë“œ\s*$/g, 'ì›”ë“œì»µ');
            
            // 8. ë¬¸ì œê°€ ë„ˆë¬´ ì§§ìœ¼ë©´ ì›ë³¸ ë°˜í™˜ (í•„í„°ë§ì´ ë„ˆë¬´ ê°•í–ˆì„ ê²½ìš°)
            if (cleaned.length < 5) {
                // ì›ë³¸ì—ì„œ ìµœì†Œí•œì˜ ì •ë¦¬ë§Œ ìˆ˜í–‰
                cleaned = text.trim().replace(/\s+/g, ' ');
                // ë¬¼ìŒí‘œ ì´í›„ ì œê±°
                const qIndex = cleaned.indexOf('?');
                if (qIndex !== -1) {
                    cleaned = cleaned.substring(0, qIndex + 1);
                }
                // ë¬¸ì œã€ ê°™ì€ íŒ¨í„´ ì œê±°
                cleaned = cleaned.replace(/ë¬¸ì œ[ã€ã€:ï¼š]\s*/g, '');
                cleaned = cleaned.replace(/^ë¬¸ì œ\s+/g, '');
            }
            
            return cleaned;
        }

        // í•µì‹¬ í‚¤ì›Œë“œë§Œ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜
        function extractKeywords(text) {
            if (!text) return [];
            
            // 1. ë¬¸ì œë§Œ ì¶”ì¶œ (ì´ë¯¸ extractQuestionìœ¼ë¡œ ì²˜ë¦¬ëœ ê²½ìš°)
            let cleaned = text.trim();
            
            // 2. ë¬¼ìŒí‘œ, íŠ¹ìˆ˜ë¬¸ì ì œê±° (ë‹¨, ìˆ«ìëŠ” ìœ ì§€)
            // ëŒ€ê´„í˜¸ëŠ” ê³µë°±ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ë‹¨ì–´ ë¶„ë¦¬ ê°œì„ 
            cleaned = cleaned.replace(/[?.,!;:(){}ã€ã€]/g, ' ');
            cleaned = cleaned.replace(/[\[\]]/g, ' '); // ëŒ€ê´„í˜¸ëŠ” ê³µë°±ìœ¼ë¡œ
            
            // 3. ì ‘ì†ì‚¬ ë° ë¶ˆí•„ìš”í•œ ë‹¨ì–´ ì œê±° (ë‹¨ì–´ ë‹¨ìœ„ë¡œ)
            const conjunctions = ['ê·¸ë¦¬ê³ ', 'ë˜í•œ', 'ë˜ëŠ”', 'í•˜ì§€ë§Œ', 'ê·¸ëŸ¬ë‚˜', 'ê·¸ëŸ°ë°', 'ë”°ë¼ì„œ', 'ê·¸ë˜ì„œ', 'ê·¸ëŸ¬ë¯€ë¡œ', 'ê·¸ëŸ¬ë©´', 'ë§Œì•½', 'ë§Œì¼', 'ë§Œì•½ì—'];
            conjunctions.forEach(conj => {
                // ë‹¨ì–´ ë‹¨ìœ„ë¡œë§Œ ì œê±° (ê³µë°±ìœ¼ë¡œ êµ¬ë¶„ëœ)
                const escaped = conj.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(^|\\s)${escaped}(\\s|$)`, 'gi');
                cleaned = cleaned.replace(regex, ' ');
            });
            
            // 4. ì¡°ì‚¬ ì œê±° (ë” ë³´ìˆ˜ì ìœ¼ë¡œ - ë‹¨ì–´ ëì—ë§Œ, ìµœì†Œ 2ê¸€ì ì´ìƒì¸ ë‹¨ì–´ì—ì„œë§Œ)
            const particles = ['ì€', 'ëŠ”', 'ì´', 'ê°€', 'ì„', 'ë¥¼', 'ì˜', 'ì—', 'ì—ì„œ', 'ì™€', 'ê³¼', 'ë„', 'ë§Œ', 'ì¡°ì°¨', 'ê¹Œì§€', 'ë¶€í„°', 'ì—ê²Œ', 'í•œí…Œ', 'ê»˜', 'ë¡œ', 'ìœ¼ë¡œ', 'ì²˜ëŸ¼', 'ê°™ì´', 'ë§Œí¼', 'ë³´ë‹¤'];
            particles.forEach(particle => {
                // ë‹¨ì–´ ëì— ë¶™ì€ ì¡°ì‚¬ë§Œ ì œê±° (ìµœì†Œ 2ê¸€ì ì´ìƒì¸ ë‹¨ì–´ì—ì„œë§Œ)
                const escapedParticle = particle.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`([ê°€-í£a-zA-Z0-9]{2,})${escapedParticle}(?=\\s|$)`, 'g');
                cleaned = cleaned.replace(regex, '$1');
                // ë‹¨ë…ìœ¼ë¡œ ìˆëŠ” ì¡°ì‚¬ ì œê±°
                const regex2 = new RegExp(`(^|\\s)${escapedParticle}(\\s|$)`, 'g');
                cleaned = cleaned.replace(regex2, ' ');
            });
            
            // 5. ê³µë°± ì •ë¦¬
            cleaned = cleaned.replace(/\s+/g, ' ').trim();
            
            // 6. í‚¤ì›Œë“œ ì¶”ì¶œ (1ê¸€ì í•„í„°ë§ ì™„í™”)
            const keywords = cleaned.split(' ')
                .filter(word => {
                    const trimmed = word.trim();
                    // ë¹ˆ ë¬¸ìì—´ ì œê±°
                    if (trimmed.length === 0) return false;
                    // 1ê¸€ì ë‹¨ì–´ë„ í¬í•¨ (ìˆ«ìë¿ë§Œ ì•„ë‹ˆë¼ í•œê¸€ë„)
                    // ë‹¨, ì¡°ì‚¬ë§Œ ìˆëŠ” ê²½ìš°ëŠ” ì œì™¸
                    if (trimmed.length === 1) {
                        // ìˆ«ìëŠ” í•­ìƒ í¬í•¨
                        if (/^\d$/.test(trimmed)) return true;
                        // í•œê¸€ 1ê¸€ìë„ í¬í•¨ (ì˜ë¯¸ ìˆëŠ” ë‹¨ì–´ì¼ ìˆ˜ ìˆìŒ)
                        if (/^[ê°€-í£]$/.test(trimmed)) return true;
                    }
                    return true;
                })
                .map(word => word.trim().toLowerCase())
                .filter(word => word.length > 0);
            
            // 7. ì¤‘ë³µ ì œê±°
            return [...new Set(keywords)];
        }

        // í‚¤ì›Œë“œ ê¸°ë°˜ ê²€ìƒ‰ í•¨ìˆ˜ (ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ë¬¸ì œë§Œ ê²€ìƒ‰)
        function searchByKeywords(keywords, question, answer, isJokboMode = false) {
            if (keywords.length === 0) return false;
            
            const questionLower = question.toLowerCase();
            const answerLower = answer.toLowerCase();
            
            if (isJokboMode) {
                // ìë™ì¡±ë³´ ëª¨ë“œ: í‚¤ì›Œë“œ ì¤‘ ì¼ë¶€ë§Œ í¬í•¨ë˜ì–´ë„ ê²€ìƒ‰ (OR ì¡°ê±´)
                // ë˜ëŠ” í‚¤ì›Œë“œì˜ ì¼ë¶€ë§Œ ë§¤ì¹­ë˜ì–´ë„ ê²€ìƒ‰
                return keywords.some(keyword => {
                    const keywordLower = keyword.toLowerCase();
                    
                    // 1. ì •í™•í•œ ë‹¨ì–´ ë§¤ì¹­
                    const escapedKeyword = escapeRegex(keyword);
                    const wordRegex = new RegExp(`(^|\\s)${escapedKeyword}(\\s|$)`, 'i');
                    if (wordRegex.test(questionLower) || wordRegex.test(answerLower)) {
                        return true;
                    }
                    
                    // 2. ê³µë°± ì œê±° ë²„ì „ìœ¼ë¡œ í™•ì¸
                    const questionNoSpace = questionLower.replace(/\s+/g, '');
                    const answerNoSpace = answerLower.replace(/\s+/g, '');
                    const keywordNoSpace = keywordLower.replace(/\s+/g, '');
                    if (questionNoSpace.includes(keywordNoSpace) || answerNoSpace.includes(keywordNoSpace)) {
                        return true;
                    }
                    
                    // 3. ë¶€ë¶„ ë¬¸ìì—´ ë§¤ì¹­ (í‚¤ì›Œë“œì˜ ì¼ë¶€ë§Œ í¬í•¨ë˜ì–´ë„ ê²€ìƒ‰)
                    // í‚¤ì›Œë“œê°€ 3ê¸€ì ì´ìƒì´ë©´ 2ê¸€ì ì´ìƒ í¬í•¨ë˜ì–´ë„ ê²€ìƒ‰
                    if (keyword.length >= 3) {
                        const minLength = Math.max(2, Math.floor(keyword.length * 0.5)); // ìµœì†Œ 50% ì´ìƒ
                        for (let i = 0; i <= keyword.length - minLength; i++) {
                            const substring = keyword.substring(i, i + minLength);
                            if (questionLower.includes(substring) || answerLower.includes(substring)) {
                                return true;
                            }
                        }
                    }
                    
                    // 4. í‚¤ì›Œë“œê°€ 2ê¸€ì ì´ìƒì´ë©´ ì§ì ‘ í¬í•¨ ì—¬ë¶€ í™•ì¸
                    if (keyword.length >= 2) {
                        if (questionLower.includes(keywordLower) || answerLower.includes(keywordLower)) {
                            return true;
                        }
                    }
                    
                    return false;
                });
            } else {
                // ê¸°ì¡´ ë¡œì§: ëª¨ë“  í‚¤ì›Œë“œê°€ í¬í•¨ë˜ì–´ì•¼ í•¨ (AND ì¡°ê±´)
                return keywords.every(keyword => {
                    // í‚¤ì›Œë“œê°€ ë‹¨ì–´ ë‹¨ìœ„ë¡œ í¬í•¨ë˜ëŠ”ì§€ í™•ì¸ (ì •í™•í•œ ë‹¨ì–´ ë§¤ì¹­)
                    const escapedKeyword = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const regex = new RegExp(`(^|\\s)${escapedKeyword}(\\s|$)`, 'i');
                    const exactMatch = regex.test(questionLower) || regex.test(answerLower);
                    
                    // ì •í™•í•œ ë‹¨ì–´ ë§¤ì¹­ì´ ì‹¤íŒ¨í–ˆì„ ë•Œ, ê³µë°± ì œê±° ë²„ì „ìœ¼ë¡œë„ í™•ì¸
                    // ì˜ˆ: 'ê·¼ë¡œìê°€ì—°' ì…ë ¥ ì‹œ 'ê·¼ë¡œìê°€ ì—°ê°„'ì—ì„œ ê³µë°± ì œê±° í›„ 'ê·¼ë¡œìê°€ì—°ê°„'ê³¼ ë¹„êµ
                    if (!exactMatch) {
                        const questionNoSpace = questionLower.replace(/\s+/g, '');
                        const answerNoSpace = answerLower.replace(/\s+/g, '');
                        return questionNoSpace.includes(keyword) || answerNoSpace.includes(keyword);
                    }
                    
                    return exactMatch;
                });
            }
        }

        // ì¼ì¹˜ë„ ì ìˆ˜ ê³„ì‚° í•¨ìˆ˜ (ìë™ì¡±ë³´ ëª¨ë“œìš©)
        function calculateMatchScore(keywords, question, answer) {
            if (keywords.length === 0) return 0;
            
            const questionLower = question.toLowerCase();
            const answerLower = answer.toLowerCase();
            let totalScore = 0;
            let matchedKeywords = 0;
            
            // ê²€ìƒ‰ì–´ ì „ì²´ë¥¼ í•˜ë‚˜ì˜ ë¬¸ìì—´ë¡œ í•©ì¹œ ë²„ì „ë„ ê³ ë ¤
            const fullSearchTerm = keywords.join(' ').toLowerCase();
            const questionNoSpace = questionLower.replace(/\s+/g, '');
            const answerNoSpace = answerLower.replace(/\s+/g, '');
            const fullSearchNoSpace = fullSearchTerm.replace(/\s+/g, '');
            
            // ì „ì²´ ê²€ìƒ‰ì–´ê°€ í¬í•¨ë˜ë©´ ë§¤ìš° ë†’ì€ ì ìˆ˜ (200ì )
            if (questionLower.includes(fullSearchTerm) || answerLower.includes(fullSearchTerm)) {
                totalScore += 200;
            } else if (questionNoSpace.includes(fullSearchNoSpace) || answerNoSpace.includes(fullSearchNoSpace)) {
                totalScore += 150;
            }
            
            // ê° í‚¤ì›Œë“œë³„ ì ìˆ˜ ê³„ì‚°
            keywords.forEach(keyword => {
                const keywordLower = keyword.toLowerCase();
                let keywordScore = 0;
                let matched = false;
                
                // ì •í™•í•œ ë‹¨ì–´ ë§¤ì¹­
                const escapedKeyword = escapeRegex(keyword);
                const wordRegex = new RegExp(`(^|\\s)${escapedKeyword}(\\s|$)`, 'i');
                const exactMatchInQuestion = wordRegex.test(questionLower);
                const exactMatchInAnswer = wordRegex.test(answerLower);
                
                if (exactMatchInQuestion || exactMatchInAnswer) {
                    keywordScore = 100;
                    matched = true;
                    if (exactMatchInQuestion && exactMatchInAnswer) {
                        keywordScore = 150;
                    }
                } else {
                    // ê³µë°± ì œê±° ë²„ì „
                    const keywordNoSpace = keywordLower.replace(/\s+/g, '');
                    const noSpaceMatchInQuestion = questionNoSpace.includes(keywordNoSpace);
                    const noSpaceMatchInAnswer = answerNoSpace.includes(keywordNoSpace);
                    
                    if (noSpaceMatchInQuestion || noSpaceMatchInAnswer) {
                        keywordScore = 80;
                        matched = true;
                        if (noSpaceMatchInQuestion && noSpaceMatchInAnswer) {
                            keywordScore = 120;
                        }
                    } else if (keyword.length >= 2) {
                        // ë¶€ë¶„ ë§¤ì¹­
                        if (questionLower.includes(keywordLower) || answerLower.includes(keywordLower)) {
                            keywordScore = 30;
                            matched = true;
                        }
                    }
                }
                
                if (matched) {
                    // í‚¤ì›Œë“œ ê¸¸ì´ ê°€ì¤‘ì¹˜
                    keywordScore *= (1 + keyword.length * 0.1);
                    totalScore += keywordScore;
                    matchedKeywords++;
                }
            });
            
            // ë§¤ì¹­ëœ í‚¤ì›Œë“œ ìˆ˜ì— ë¹„ë¡€í•œ ë³´ë„ˆìŠ¤ (ê³±í•˜ê¸° ëŒ€ì‹  ë”í•˜ê¸°ë¡œ ë³€ê²½)
            // ë§¤ì¹­ëœ í‚¤ì›Œë“œê°€ ë§ì„ìˆ˜ë¡ ë³´ë„ˆìŠ¤ ì¶”ê°€
            const matchRatio = matchedKeywords / keywords.length;
            totalScore += totalScore * (matchRatio * 0.3); // ë§¤ì¹­ ë¹„ìœ¨ì— ë”°ë¥¸ ë³´ë„ˆìŠ¤ ì¶”ê°€
            
            // ì¶”ê°€ë¡œ ë§¤ì¹­ëœ í‚¤ì›Œë“œ ìˆ˜ì— ë¹„ë¡€í•œ ê³ ì • ë³´ë„ˆìŠ¤
            totalScore += matchedKeywords * 10;
            
            return totalScore;
        }

        // OCR ê²°ê³¼ë¥¼ ê²€ìƒ‰ì°½ì— ì…ë ¥í•˜ê³  ê²€ìƒ‰ ì‹¤í–‰
        function processOCRResult(text, isAutoMode = false) {
            // í…ìŠ¤íŠ¸ ì •ë¦¬ (ì´ë¯¸ extractQuestionìœ¼ë¡œ ì²˜ë¦¬ëœ ê²½ìš°ë„ ìˆìŒ)
            let cleanedText = text.trim().replace(/\s+/g, ' ').replace(/\n/g, ' ');
            
            // ë¬¸ì œë§Œ ì¶”ì¶œ (ì•„ì§ ì²˜ë¦¬ë˜ì§€ ì•Šì€ ê²½ìš°)
            if (!cleanedText.includes('?') || cleanedText.includes('ë¬¸ì œ') || cleanedText.includes('[')) {
                cleanedText = extractQuestion(cleanedText);
            }
            
            if (cleanedText && cleanedText.length > 0) {
                // í‚¤ì›Œë“œ ì¶”ì¶œ
                let keywords = extractKeywords(cleanedText);
                
                // í‚¤ì›Œë“œ ì¶”ì¶œ ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ ë¡œì§
                if (keywords.length === 0) {
                    // ìµœì†Œí•œì˜ ì •ë¦¬ë§Œ ìˆ˜í–‰í•˜ì—¬ í‚¤ì›Œë“œ ì¶”ì¶œ ì¬ì‹œë„
                    const fallbackText = cleanedText.replace(/[?.,!;:()[\]{}ã€ã€]/g, ' ').trim();
                    keywords = fallbackText.split(' ')
                        .filter(word => word.length >= 2)
                        .map(word => word.toLowerCase())
                        .filter(word => word.length > 0);
                }
                
                // ë””ë²„ê¹… ë¡œê·¸ (ê°œë°œ í™˜ê²½ì—ì„œë§Œ)
                if (!isAutoMode) {
                    console.log('OCR ê²°ê³¼:', text);
                    console.log('ì¶”ì¶œëœ ë¬¸ì œ:', cleanedText);
                    console.log('ì¶”ì¶œëœ í‚¤ì›Œë“œ:', keywords);
                }
                
                // í‚¤ì›Œë“œë¥¼ í•œ ë²ˆì— ê²€ìƒ‰ì°½ì— ì…ë ¥í•˜ê³  ê²€ìƒ‰
                const searchTerm = keywords.join(' ');
                if (searchInput) {
                    searchInput.value = searchTerm;
                }
                currentSearchTerm = searchTerm;
                displayedCount = 0;
                
                if (clearSearchBtn) {
                    clearSearchBtn.classList.add('show');
                }
                
                // ê²€ìƒ‰ ì‹¤í–‰
                performSearch();
                
                // ê²€ìƒ‰ ê²°ê³¼ í™•ì¸ (ê²€ìƒ‰ ê²°ê³¼ê°€ ë‚˜ì™”ìœ¼ë©´ ìë™ ìº¡ì²˜ ì¤‘ì§€ - ë‹¨, ì¤‘ë‹¨ì—†ì´ ì²´í¬ë°•ìŠ¤ê°€ ì²´í¬ë˜ì–´ ìˆìœ¼ë©´ ì¤‘ì§€í•˜ì§€ ì•ŠìŒ)
                setTimeout(() => {
                    if (allFilteredResults.length > 0 && isAutoCaptureMode) {
                        // ì¤‘ë‹¨ì—†ì´ ì²´í¬ë°•ìŠ¤ê°€ ì²´í¬ë˜ì–´ ìˆìœ¼ë©´ ìë™ ìº¡ì²˜ ê³„ì†
                        const shouldContinue = cameraContinueCheckbox && cameraContinueCheckbox.checked;
                        if (!shouldContinue) {
                            stopAutoCapture();
                            if (!isAutoMode) {
                                showNotification('ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤. ìë™ ìº¡ì²˜ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            }
                        }
                    }
                }, 100);
                
                // ì•Œë¦¼ í‘œì‹œ
                if (!isAutoMode) {
                    showNotification('ë¬¸ì œë¥¼ ì¸ì‹í–ˆìŠµë‹ˆë‹¤');
                } else {
                    showNotification('ë¬¸ì œê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤');
                }
            } else {
                if (!isAutoMode) {
                    alert('í…ìŠ¤íŠ¸ë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    cameraLoading.style.display = 'none';
                    cameraLoading.textContent = 'OCR ì²˜ë¦¬ ì¤‘...';
                    cameraCaptureBtn.disabled = false;
                }
            }
        }


        // ê²€ìƒ‰ ê´€ë ¨ ë³€ìˆ˜ ì„ ì–¸ (ì „ì—­)
        let searchInput = null;
        let clearSearchBtn = null;

        // ê²€ìƒ‰ ê¸°ëŠ¥ ì´ˆê¸°í™”
        function initSearch() {
            searchInput = document.getElementById('searchInput');
            clearSearchBtn = document.getElementById('clearSearchBtn');
            
            if (!searchInput || !clearSearchBtn) {
                console.error('ê²€ìƒ‰ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                // ì¬ì‹œë„
                setTimeout(initSearch, 100);
                return;
            }

            // ê²€ìƒ‰ ê¸°ëŠ¥ (ë””ë°”ìš´ì‹± ì ìš©)
            searchInput.addEventListener('input', function(e) {
                const value = e.target.value.trim();
                currentSearchTerm = value;
                
                // ì§€ìš°ê¸° ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
                if (currentSearchTerm) {
                    clearSearchBtn.classList.add('show');
                } else {
                    clearSearchBtn.classList.remove('show');
                }
                
                // ë””ë°”ìš´ì‹±: 300ms ì§€ì—°
                if (debounceTimer) {
                    clearTimeout(debounceTimer);
                }
                
                debounceTimer = setTimeout(() => {
                    displayedCount = 0; // ê²€ìƒ‰ì–´ ë³€ê²½ ì‹œ ë¦¬ì…‹
                    performSearch();
                }, 300);
            });

            // ì§€ìš°ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            clearSearchBtn.addEventListener('click', function() {
                clearSearchInput();
            });
        }

        // ê²€ìƒ‰ì–´ ì§€ìš°ê¸° í•¨ìˆ˜
        function clearSearchInput() {
            if (!searchInput || !clearSearchBtn) return;
            searchInput.value = '';
            currentSearchTerm = '';
            clearSearchBtn.classList.remove('show');
            displayedCount = 0;
            performSearch();
            searchInput.focus();
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë“  ê¸°ëŠ¥ ì´ˆê¸°í™”
        function initAll() {
            initEventListeners();
            initSearch();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAll);
        } else {
            initAll();
        }

        function performSearch(resetDisplay = false) {
            const resultsDiv = document.getElementById('results');
            
            if (!currentSearchTerm) {
                const totalCount = selectedSheet 
                    ? questionsData.filter(item => item.sheet === selectedSheet).length 
                    : questionsData.length;
                
                resultsDiv.innerHTML = 
                    `<div class="results-count">ì´ ${totalCount}ê°œì˜ ë¬¸ì œê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ${selectedSheet ? `(ì¹´í…Œê³ ë¦¬: ${selectedSheet})` : ''} ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</div>`;
                allFilteredResults = [];
                displayedCount = 0;
                return;
            }

            if (questionsData.length === 0) {
                resultsDiv.innerHTML = '<div class="no-results">ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
                allFilteredResults = [];
                displayedCount = 0;
                return;
            }

            // ê²€ìƒ‰ ìˆ˜í–‰ (ì„ íƒëœ ì¹´í…Œê³ ë¦¬ë§Œ) - ê²€ìƒ‰ì–´ê°€ ë³€ê²½ë˜ì—ˆê±°ë‚˜ ë¦¬ì…‹ ìš”ì²­ ì‹œì—ë§Œ ì¬ê²€ìƒ‰
            // ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•œ ê²€ìƒ‰ì–´ëŠ” ì¡°ì‚¬ ì œê±° ì—†ì´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            // ê³µë°±ìœ¼ë¡œ êµ¬ë¶„ëœ ë‹¨ì–´ë“¤ì„ í‚¤ì›Œë“œë¡œ ì‚¬ìš©
            let keywords = [];
            if (currentSearchTerm.trim().length > 0) {
                keywords = currentSearchTerm.trim()
                    .split(/\s+/)
                    .filter(word => word.length > 0)
                    .map(word => word.toLowerCase());
            }
            
            if (resetDisplay || displayedCount === 0) {
                allFilteredResults = questionsData.filter(item => {
                // ì„ íƒëœ ì‹œíŠ¸ì¸ì§€ í™•ì¸
                if (selectedSheet && item.sheet !== selectedSheet) {
                    return false;
                }
                    
                    // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ê²€ìƒ‰í•˜ì§€ ì•ŠìŒ
                    if (!currentSearchTerm || currentSearchTerm.trim().length === 0) {
                        return false;
                    }
                    
                    // í‚¤ì›Œë“œ ê¸°ë°˜ ê²€ìƒ‰ (í‚¤ì›Œë“œê°€ 1ê°œ ì´ìƒì¼ ë•Œ ì‚¬ìš©)
                    if (keywords.length >= 1) {
                        return searchByKeywords(keywords, item.question, item.answer, autoJokboEnabled);
                    }
                    
                    // í‚¤ì›Œë“œê°€ ì—†ìœ¼ë©´ ê²€ìƒ‰í•˜ì§€ ì•ŠìŒ
                    return false;
                });
                
                // ìë™ì¡±ë³´ ëª¨ë“œì¼ ë•Œ ì¼ì¹˜ë„ ì ìˆ˜ë¡œ ì •ë ¬
                if (autoJokboEnabled && keywords.length > 0) {
                    allFilteredResults = allFilteredResults.map(item => ({
                        ...item,
                        matchScore: calculateMatchScore(keywords, item.question, item.answer)
                    })).sort((a, b) => {
                        // ì¼ì¹˜ë„ ì ìˆ˜ê°€ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬
                        return b.matchScore - a.matchScore;
                    });
                }
                
                displayedCount = 0;
            }

            if (allFilteredResults.length === 0) {
                resultsDiv.innerHTML = '<div class="no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            // ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆì„ ë•Œ ìë™ ìº¡ì²˜ ì¤‘ì§€ (ë‹¨, ì¤‘ë‹¨ì—†ì´ ì²´í¬ë°•ìŠ¤ê°€ ì²´í¬ë˜ì–´ ìˆìœ¼ë©´ ì¤‘ì§€í•˜ì§€ ì•ŠìŒ)
            if (allFilteredResults.length > 0 && isAutoCaptureMode && displayedCount === 0) {
                // ì¤‘ë‹¨ì—†ì´ ì²´í¬ë°•ìŠ¤ê°€ ì²´í¬ë˜ì–´ ìˆìœ¼ë©´ ìë™ ìº¡ì²˜ ê³„ì†
                const shouldContinue = cameraContinueCheckbox && cameraContinueCheckbox.checked;
                if (!shouldContinue) {
                    stopAutoCapture();
                    showNotification('ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤. ìë™ ìº¡ì²˜ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            }

            // í‘œì‹œí•  ê°œìˆ˜ ê³„ì‚°
            const startIndex = displayedCount;
            const toDisplay = Math.min(maxResults, allFilteredResults.length - displayedCount);
            const itemsToRender = allFilteredResults.slice(startIndex, startIndex + toDisplay);
            const isFirstLoad = startIndex === 0;

            // ê²°ê³¼ í‘œì‹œ
            let html = '';
            
            // ì²˜ìŒ ë¡œë“œí•˜ëŠ” ê²½ìš°ì—ë§Œ ì¹´ìš´íŠ¸ í‘œì‹œ
            if (isFirstLoad) {
                html = `<div class="results-count">ê²€ìƒ‰ ê²°ê³¼: ${allFilteredResults.length}ê°œ`;
            if (selectedSheet) {
                html += ` (ì¹´í…Œê³ ë¦¬: ${selectedSheet})`;
            }
            html += `</div>`;
            }
            
            itemsToRender.forEach(item => {
                // ë¬¸ì œ í…ìŠ¤íŠ¸ì—ì„œ "[ë¬¸ì œ]" ì œê±°
                let questionText = item.question.replace(/\[ë¬¸ì œ\s*\d+\]|\[ë¬¸ì œ\]|\[\d+\]/g, '').trim();
                // í‚¤ì›Œë“œ ê¸°ë°˜ í•˜ì´ë¼ì´íŠ¸ (ê° í‚¤ì›Œë“œë¥¼ ê°œë³„ì ìœ¼ë¡œ í•˜ì´ë¼ì´íŠ¸)
                const highlightedQuestion = highlightTextWithKeywords(questionText, keywords.length > 0 ? keywords : [currentSearchTerm]);
                const highlightedAnswer = highlightTextWithKeywords(item.answer, keywords.length > 0 ? keywords : [currentSearchTerm]);
                const answerEscaped = escapeHtml(item.answer);
                
                html += `
                    <div class="result-item" data-answer="${answerEscaped.replace(/"/g, '&quot;')}">
                        <div class="result-sheet">
                            <span class="sheet-tag">${escapeHtml(item.sheet || 'ì•Œ ìˆ˜ ì—†ìŒ')}</span>
                        </div>
                        <div class="result-question">${highlightedQuestion}</div>
                        <div class="result-answer">${highlightedAnswer}</div>
                    </div>
                `;
            });

            displayedCount += toDisplay;

            // ë” ë³´ê¸° ë²„íŠ¼ ì¶”ê°€
            if (displayedCount < allFilteredResults.length) {
                html += `<button class="load-more-btn" onclick="loadMoreResults()">ë” ë³´ê¸° (${allFilteredResults.length - displayedCount}ê°œ ë‚¨ìŒ)</button>`;
            }

            // ê¸°ì¡´ ê²°ê³¼ì— ì¶”ê°€í•˜ê±°ë‚˜ ìƒˆë¡œ ë Œë”ë§
            if (isFirstLoad) {
            resultsDiv.innerHTML = html;
            } else {
                // ë” ë³´ê¸° ë²„íŠ¼ ì œê±° í›„ ì¶”ê°€
                const loadMoreBtn = resultsDiv.querySelector('.load-more-btn');
                if (loadMoreBtn) {
                    loadMoreBtn.remove();
                }
                resultsDiv.insertAdjacentHTML('beforeend', html);
            }

            // ìë™ë³µì‚¬ ê¸°ëŠ¥ (ì„±ëŠ¥ ìµœì í™”: ë¹„ë™ê¸° ì²˜ë¦¬) - ì²« ë²ˆì§¸ ê²°ê³¼ë§Œ ë³µì‚¬
            if (autoCopyEnabled && selectedSheet === "ê½ê½" && allFilteredResults.length > 0 && isFirstLoad) {
                const firstAnswer = allFilteredResults[0].answer;
                // ë Œë”ë§ ë¸”ë¡œí‚¹ ë°©ì§€ë¥¼ ìœ„í•´ ë¹„ë™ê¸° ì²˜ë¦¬
                setTimeout(() => {
                    copyToClipboard(firstAnswer).catch(() => {
                        // ë³µì‚¬ ì‹¤íŒ¨ ì‹œ ì¡°ìš©íˆ ì²˜ë¦¬ (ì‚¬ìš©ì ê²½í—˜ ë°©í•´ ìµœì†Œí™”)
                    });
                }, 0);
            }
        }

        // ë” ë³´ê¸° ë²„íŠ¼ í•¨ìˆ˜
        function loadMoreResults() {
            performSearch(false);
        }

        // í…ìŠ¤íŠ¸ í•˜ì´ë¼ì´íŠ¸ (ë‹¨ì¼ ê²€ìƒ‰ì–´)
        function highlightText(text, searchTerm) {
            if (!searchTerm) return escapeHtml(text);
            
            const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
            return escapeHtml(text).replace(regex, '<span class="highlight">$1</span>');
        }

        // í‚¤ì›Œë“œ ê¸°ë°˜ í…ìŠ¤íŠ¸ í•˜ì´ë¼ì´íŠ¸ (ì—¬ëŸ¬ í‚¤ì›Œë“œë¥¼ ê°œë³„ì ìœ¼ë¡œ í•˜ì´ë¼ì´íŠ¸)
        function highlightTextWithKeywords(text, keywords) {
            if (!text || !keywords || keywords.length === 0) return escapeHtml(text);
            
            let highlightedText = escapeHtml(text);
            const textLower = text.toLowerCase();
            
            // ê° í‚¤ì›Œë“œë¥¼ í•˜ì´ë¼ì´íŠ¸ (ê¸´ í‚¤ì›Œë“œë¶€í„° ì²˜ë¦¬í•˜ì—¬ ì¤‘ì²© ë°©ì§€)
            const sortedKeywords = [...keywords].sort((a, b) => b.length - a.length);
            
            sortedKeywords.forEach(keyword => {
                if (!keyword || keyword.trim().length === 0) return;
                
                const keywordLower = keyword.toLowerCase();
                const escapedKeyword = escapeRegex(keyword);
                
                // 1. ì •í™•í•œ ë‹¨ì–´ ë‹¨ìœ„ ë§¤ì¹­ ì‹œë„ (ê³µë°±ìœ¼ë¡œ êµ¬ë¶„ëœ ë‹¨ì–´)
                const wordRegex = new RegExp(`(^|\\s)(${escapedKeyword})(\\s|$)`, 'gi');
                const hasWordMatch = wordRegex.test(textLower);
                
                if (hasWordMatch) {
                    // ë‹¨ì–´ ë‹¨ìœ„ë¡œ í•˜ì´ë¼ì´íŠ¸
                    highlightedText = highlightedText.replace(wordRegex, (match, before, keywordMatch, after) => {
                        // ì´ë¯¸ í•˜ì´ë¼ì´íŠ¸ëœ ë¶€ë¶„ì€ ê±´ë„ˆë›°ê¸°
                        if (before.includes('<span') || keywordMatch.includes('<span')) {
                            return match;
                        }
                        return `${before}<span class="highlight">${keywordMatch}</span>${after}`;
                    });
                } else {
                    // 2. ë‹¨ì–´ ë‹¨ìœ„ ë§¤ì¹­ì´ ì—†ìœ¼ë©´ ê³µë°± ì œê±° ë²„ì „ìœ¼ë¡œ í™•ì¸
                    const textNoSpace = textLower.replace(/\s+/g, '');
                    const keywordNoSpace = keywordLower.replace(/\s+/g, '');
                    
                    if (textNoSpace.includes(keywordNoSpace)) {
                        // ì›ë³¸ í…ìŠ¤íŠ¸ì—ì„œ í‚¤ì›Œë“œê°€ í¬í•¨ëœ ë¶€ë¶„ ì°¾ê¸° (ê³µë°± ë¬´ì‹œ)
                        // ê°„ë‹¨í•˜ê²Œ í‚¤ì›Œë“œ ìì²´ë¥¼ í•˜ì´ë¼ì´íŠ¸ (ê³µë°± í¬í•¨ ê°€ëŠ¥)
                        const simpleRegex = new RegExp(`(${escapedKeyword})`, 'gi');
                        if (!highlightedText.toLowerCase().includes(`<span class="highlight">${keywordLower}</span>`)) {
                            highlightedText = highlightedText.replace(simpleRegex, '<span class="highlight">$1</span>');
                        }
                    }
                }
            });
            
            return highlightedText;
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ì •ê·œì‹ ì´ìŠ¤ì¼€ì´í”„
        function escapeRegex(text) {
            return text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // ì¹´í…Œê³ ë¦¬ í•„í„° UI ìƒì„±
        function createCategoryFilters() {
            const categorySelect = document.getElementById('categorySelect');
            const categorySection = document.getElementById('categorySection');
            
            categorySelect.innerHTML = '';
            
            // ê¸°ë³¸ ì„ íƒê°’ì´ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ì‹œíŠ¸ ì„ íƒ
            if (!selectedSheet && allSheetNames.length > 0) {
                selectedSheet = allSheetNames[0];
            }
            
            // ì˜µì…˜ ì¶”ê°€
            allSheetNames.forEach(sheetName => {
                const option = document.createElement('option');
                option.value = sheetName;
                option.textContent = sheetName;
                if (selectedSheet === sheetName) {
                    option.selected = true;
                }
                categorySelect.appendChild(option);
            });
            
            // ë“œë¡­ë‹¤ìš´ í™œì„±í™”
            categorySelect.disabled = false;
            categorySection.classList.add('active');
            
            // ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            categorySelect.onchange = function(e) {
                selectCategory(e.target.value);
            };
        }

        // ì¹´í…Œê³ ë¦¬ ì„ íƒ (ë‹¨ì¼ ì„ íƒ)
        function selectCategory(sheetName) {
            selectedSheet = sheetName;
            displayedCount = 0; // ë¦¬ì…‹
            // ê²€ìƒ‰ ë‹¤ì‹œ ìˆ˜í–‰
            performSearch(true);
        }

        // ì‚¬ìš©ë°©ë²• ëª¨ë‹¬ ê¸°ëŠ¥
        const helpModalOverlay = document.getElementById('helpModalOverlay');
        const helpModal = document.getElementById('helpModal');
        const helpBtn = document.getElementById('helpBtn');
        const helpModalClose = document.getElementById('helpModalClose');
        
        // ì‚¬ìš©ë°©ë²• ëª¨ë‹¬ ì—´ê¸°
        function openHelpModal() {
            if (helpModal && helpModalOverlay) {
                helpModalOverlay.classList.add('show');
                helpModal.classList.add('show');
            }
        }
        
        // ì‚¬ìš©ë°©ë²• ëª¨ë‹¬ ë‹«ê¸°
        function closeHelpModal() {
            if (helpModal && helpModalOverlay) {
                helpModal.classList.remove('show');
                helpModalOverlay.classList.remove('show');
            }
        }
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        if (helpBtn) {
            helpBtn.addEventListener('click', openHelpModal);
        }
        
        if (helpModalClose) {
            helpModalClose.addEventListener('click', closeHelpModal);
        }
        
        // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        if (helpModalOverlay) {
            helpModalOverlay.addEventListener('click', closeHelpModal);
        }
    </script>
</body>
</html>

