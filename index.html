<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qplay ì¡±ë³´</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color:#333333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 0;
            box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border-radius: 10px;
        }

        .header {
            color: #333333;
            padding: 20px 30px;
            text-align: left;
            border-bottom: 1px solid #ffffff;
        }

        .header h2 {
            font-size: 1.5em;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 20px;
        }

        .search-section {
            margin-bottom: 20px;
        }

        .search-box {
            width: 100%;
            padding: 18px 24px;
            font-size: 1.1em;
            border: 1px solid #000000;
            border-radius: 0;
            background: #ffffff;
            color: #000000;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #000000;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
        }

        .camera-btn {
            position: absolute;
            right: 50px;
            background: none;
            border: none;
            color: #999;
            font-size: 1.2em;
            cursor: pointer;
            padding: 4px 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .camera-btn:hover {
            color: #000000;
        }

        .camera-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .search-box::placeholder {
            color: #999999;
        }

        .results-section {
            margin-top: 30px;
        }

        .results-count {
            margin-bottom: 20px;
            color: #666666;
            font-size: 1em;
        }

        .result-item {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-left: 2px solid #000000;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .result-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left-color: #000000;
        }

        .result-question {
            font-size: 1.2em;
            font-weight: 600;
            color: #000000;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .result-sheet {
            margin-bottom: 10px;
        }

        .result-answer {
            font-size: 1.1em;
            color: #333333;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 0;
            margin-top: 10px;
            line-height: 1.8;
        }

        .highlight {
            background: #000000;
            color: #ffffff;
            padding: 2px 4px;
            border-radius: 0;
            font-weight: 600;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #666666;
            font-size: 1.2em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #000000;
            font-size: 1.1em;
        }

        .error {
            background: #ffffff;
            color: #000000;
            padding: 15px;
            border-radius: 0;
            margin-top: 20px;
            border: 1px solid #000000;
            border-left: 2px solid #000000;
        }

        .sheet-tag {
            display: inline-block;
            padding: 4px 10px;
            background: #000000;
            color: #ffffff;
            border-radius: 0;
            font-size: 0.85em;
            margin-left: 10px;
            font-weight: 500;
        }

        .category-section {
            margin-bottom: 20px;
        }

        .category-section.active {
            display: block;
        }

        .category-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .category-dropdown {
            width: 220px;
            padding: 12px 16px;
            font-size: 1em;
            border: 1px solid #000000;
            border-radius: 0;
            background: #ffffff;
            color: #000000;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23000000' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }

        .auto-copy-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }

        .auto-copy-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #000000;
        }

        .auto-copy-checkbox label {
            font-size: 0.95em;
            color: #000000;
            cursor: pointer;
        }

        .result-limit-dropdown {
            width: 100px;
            padding: 12px 16px;
            font-size: 1em;
            border: 1px solid #000000;
            border-radius: 0;
            background: #ffffff;
            color: #000000;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23000000' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }

        .result-limit-dropdown:focus {
            outline: none;
            border-color: #000000;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
        }

        .result-limit-dropdown:hover {
            border-color: #000000;
        }

        .load-more-btn {
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            background: #000000;
            color: #ffffff;
            border: none;
            border-radius: 0;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .load-more-btn:hover {
            background: #333333;
        }

        .load-more-btn:active {
            background: #000000;
        }

        .category-dropdown:focus {
            outline: none;
            border-color: #000000;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
        }

        .category-dropdown:hover {
            border-color: #000000;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #000000;
            color: #ffffff;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 0.9em;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .camera-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .camera-modal.show {
            display: flex;
        }

        .camera-modal-content {
            background: #ffffff;
            border-radius: 12px;
            padding: 20px;
            max-width: 90%;
            max-height: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .camera-video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            background: #000000;
            border-radius: 8px;
            overflow: hidden;
        }

        #cameraVideo {
            width: 100%;
            height: auto;
            display: block;
        }

        .camera-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .camera-capture-btn {
            padding: 12px 24px;
            background: #000000;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .camera-capture-btn:hover {
            background: #333333;
        }

        .camera-capture-btn:disabled {
            background: #999999;
            cursor: not-allowed;
        }

        .camera-close-btn {
            padding: 12px 24px;
            background: #999999;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .camera-close-btn:hover {
            background: #666666;
        }

        .camera-loading {
            padding: 20px;
            text-align: center;
            color: #666666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>íŒŒë¥´ë¥´ ì¡±ë³´</h2>
        </div>

        <div class="content">
            <div class="category-section" id="categorySection">
                <div class="category-controls">
                    <select id="categorySelect" class="category-dropdown" disabled>
                        <option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                    <select id="resultLimitSelect" class="result-limit-dropdown">
                        <option value="10">10ê°œ</option>
                        <option value="30">30ê°œ</option>
                        <option value="50">50ê°œ</option>
                        <option value="100">100ê°œ</option>
                    </select>
                    <div class="auto-copy-checkbox">
                        <input type="checkbox" id="autoCopyCheckbox">
                        <label for="autoCopyCheckbox">ìë™ë³µì‚¬</label>
                    </div>
                </div>
            </div>

            <div class="search-section">
<<<<<<< Updated upstream
                <input 
                    type="text" 
                    id="searchInput" 
                    class="search-box" 
                    placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                    disabled
                />
=======
                <div class="search-container">
                    <input 
                        type="text" 
                        id="searchInput" 
                        class="search-box" 
                        placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                        disabled
                    />
                    <button id="cameraBtn" class="camera-btn" title="ì¹´ë©”ë¼ë¡œ ë¬¸ì œ ì¸ì‹" disabled>ğŸ“·</button>
                    <button id="clearSearchBtn" class="clear-search-btn" title="ê²€ìƒ‰ì–´ ì§€ìš°ê¸°">Ã—</button>
                </div>
>>>>>>> Stashed changes
            </div>

            <div class="results-section">
                <div id="results"></div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <div id="cameraModal" class="camera-modal">
        <div class="camera-modal-content">
            <div class="camera-video-container">
                <video id="cameraVideo" autoplay playsinline></video>
            </div>
            <div class="camera-controls">
                <button id="cameraCaptureBtn" class="camera-capture-btn">ìº¡ì²˜</button>
                <button id="cameraCloseBtn" class="camera-close-btn">ë‹«ê¸°</button>
            </div>
            <div id="cameraLoading" class="camera-loading" style="display: none;">
                OCR ì²˜ë¦¬ ì¤‘...
            </div>
        </div>
    </div>

    <script>
        let questionsData = [];
        let currentSearchTerm = '';
        let allSheetNames = [];
        let selectedSheet = null; // ë‹¨ì¼ ì„ íƒìœ¼ë¡œ ë³€ê²½
        let autoCopyEnabled = false;
        let maxResults = 10; // ê¸°ë³¸ê°’ 10ê°œ
        let displayedCount = 0;
        let allFilteredResults = [];
        let debounceTimer = null;

        // JSON ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜
        function processJsonData(jsonData) {
            try {
                questionsData = jsonData.data || [];
                allSheetNames = jsonData.metadata?.sheets || [];
                
                // ì‹œíŠ¸ ì´ë¦„ ì¶”ì¶œ (ë°ì´í„°ì—ì„œ ê³ ìœ í•œ ì‹œíŠ¸ ì´ë¦„ ì°¾ê¸°)
                if (allSheetNames.length === 0) {
                    const uniqueSheets = new Set(jsonData.data.map(item => item.sheet));
                    allSheetNames = Array.from(uniqueSheets);
                }
                
                // ì´ˆê¸°í™”: ì²« ë²ˆì§¸ ì‹œíŠ¸ ì„ íƒ
                selectedSheet = allSheetNames.length > 0 ? allSheetNames[0] : null;
                
                // ì¹´í…Œê³ ë¦¬ ì„ íƒ UI ìƒì„±
                createCategoryFilters();
                
                document.getElementById('searchInput').disabled = false;
                document.getElementById('cameraBtn').disabled = false;
                const totalCount = selectedSheet 
                    ? questionsData.filter(item => item.sheet === selectedSheet).length 
                    : questionsData.length;
                document.getElementById('results').innerHTML = 
                    `<div class="results-count">ì´ ${totalCount}ê°œì˜ ë¬¸ì œê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ${selectedSheet ? `(ì¹´í…Œê³ ë¦¬: ${selectedSheet})` : ''} ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</div>`;
            } catch (error) {
                document.getElementById('categorySection').classList.remove('active');
                document.getElementById('results').innerHTML = 
                    `<div class="error">ë°ì´í„°ë¥¼ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
                document.getElementById('searchInput').disabled = true;
            }
        }

        // Excel íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜
        function processExcelFile(fileData) {
            try {
                const data = new Uint8Array(fileData);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // ëª¨ë“  ì‹œíŠ¸ ì½ê¸°
                questionsData = [];
                allSheetNames = workbook.SheetNames;
                
                // ê° ì‹œíŠ¸ë¥¼ ìˆœíšŒí•˜ë©° ë°ì´í„° ì½ê¸°
                allSheetNames.forEach((sheetName, sheetIndex) => {
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    const sheetData = parseExcelData(jsonData, sheetName);
                    
                    // ì‹œíŠ¸ ì´ë¦„ì„ í¬í•¨í•˜ì—¬ ë°ì´í„° ì¶”ê°€
                    questionsData = questionsData.concat(sheetData);
                });
                
                // ì´ˆê¸°í™”: ì²« ë²ˆì§¸ ì‹œíŠ¸ ì„ íƒ
                selectedSheet = allSheetNames.length > 0 ? allSheetNames[0] : null;
                
                // ì¹´í…Œê³ ë¦¬ ì„ íƒ UI ìƒì„±
                createCategoryFilters();
                
                document.getElementById('searchInput').disabled = false;
                document.getElementById('cameraBtn').disabled = false;
                const totalCount = selectedSheet 
                    ? questionsData.filter(item => item.sheet === selectedSheet).length 
                    : questionsData.length;
                document.getElementById('results').innerHTML = 
                    `<div class="results-count">ì´ ${totalCount}ê°œì˜ ë¬¸ì œê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ${selectedSheet ? `(ì¹´í…Œê³ ë¦¬: ${selectedSheet})` : ''} ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</div>`;
            } catch (error) {
                document.getElementById('categorySection').classList.remove('active');
                document.getElementById('results').innerHTML = 
                    `<div class="error">íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
                document.getElementById('searchInput').disabled = true;
            }
        }


        // ê¸°ë³¸ ë°ì´í„° ìë™ ë¡œë“œ í•¨ìˆ˜ (JSON)
        function loadDefaultData() {
            document.getElementById('results').innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...</div>';
            document.getElementById('searchInput').disabled = true;
            
            // ë¨¼ì € JSON íŒŒì¼ì„ ì‹œë„
            fetch('data.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('JSON íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                    return response.json();
                })
                .then(jsonData => {
                    processJsonData(jsonData);
                })
                .catch(jsonError => {
                    console.log('JSON ë¡œë“œ ì‹¤íŒ¨:', jsonError);
                    document.getElementById('results').innerHTML = 
                        `<div class="no-results" style="text-align: center; padding: 40px;">
                            <h3 style="margin-bottom: 20px; color: #000000;">Qplay ì¡±ë³´ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</h3>
                            <p style="font-size: 1.1em; margin-bottom: 15px;">ë°ì´í„° íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                            <p style="color: #666;">data.json íŒŒì¼ì´ í•„ìš”í•œ ìœ„ì¹˜ì— ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
                        </div>`;
                    document.getElementById('searchInput').disabled = true;
                });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ê¸°ë³¸ íŒŒì¼ ë¡œë“œ ì‹œë„
        window.addEventListener('DOMContentLoaded', function() {
            // ë¡œì»¬ ì„œë²„ í™˜ê²½ì¸ì§€ í™•ì¸ (http:// ë˜ëŠ” https://ë¡œ ì‹œì‘í•˜ëŠ”ì§€)
            if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
                // ì›¹ ì„œë²„ í™˜ê²½ì—ì„œëŠ” ìë™ ë¡œë“œ ì‹œë„ (JSON)
                loadDefaultData();
            } else {
                // file:// í”„ë¡œí† ì½œì¸ ê²½ìš° ì•ˆë‚´
                document.getElementById('results').innerHTML = 
                    `<div class="no-results" style="text-align: center; padding: 40px;">
                        <h3 style="margin-bottom: 20px; color: #667eea;">ğŸ“š Qplay ì¡±ë³´ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</h3>
                        <p style="font-size: 1.1em; margin-bottom: 15px;">ë°ì´í„°ë¥¼ ë¡œë“œí•˜ë ¤ë©´ ë¡œì»¬ ì›¹ ì„œë²„ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.</p>
                        <p style="color: #666;">ë¡œì»¬ ì„œë²„ë¥¼ ì‹¤í–‰í•˜ë ¤ë©´ í„°ë¯¸ë„ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:</p>
                        <p style="color: #999; font-size: 0.9em; margin-top: 20px;">ğŸ’¡ <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 4px;">python -m http.server 8000</code></p>
                    </div>`;
            }
        });

        // Excel ë°ì´í„° íŒŒì‹±
        function parseExcelData(jsonData, sheetName) {
            if (!jsonData || jsonData.length === 0) return [];

            const data = [];
            
            // ì²« ë²ˆì§¸ í–‰ì´ í—¤ë”ì¸ì§€ í™•ì¸
            const firstRow = jsonData[0];
            let hasHeader = false;
            let questionCol = 0;
            let answerCol = 1;

            // ìë™ìœ¼ë¡œ ë¬¸ì œ/ë‹µ ì»¬ëŸ¼ ì°¾ê¸°
            if (firstRow && firstRow.length > 0) {
                const headers = firstRow.map(h => String(h || '').toLowerCase());
                
                // í—¤ë”ì—ì„œ ë¬¸ì œ/ë‹µ ì»¬ëŸ¼ ì°¾ê¸°
                const questionKeywords = ['ë¬¸ì œ', 'question', 'ì§ˆë¬¸', 'ë¬¸í•­', 'ë¬¸ì œë‚´ìš©', 'ë¬¸í•­ë‚´ìš©', 'ë‚´ìš©'];
                const answerKeywords = ['ë‹µ', 'answer', 'ì •ë‹µ', 'í•´ë‹µ', 'ë‹µì•ˆ', 'í•´ì„¤', 'ì •ë‹µë‚´ìš©'];
                
                headers.forEach((h, idx) => {
                    if (questionKeywords.some(k => h.includes(k))) {
                        questionCol = idx;
                        hasHeader = true;
                    }
                    if (answerKeywords.some(k => h.includes(k))) {
                        answerCol = idx;
                        hasHeader = true;
                    }
                });

                // í—¤ë”ê°€ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ì—´ì„ ë¬¸ì œ, ë‘ ë²ˆì§¸ ì—´ì„ ë‹µìœ¼ë¡œ ê°„ì£¼
                if (!hasHeader) {
                    questionCol = 0;
                    answerCol = 1;
                }
            }

            // ë°ì´í„° í–‰ ì²˜ë¦¬
            const startRow = hasHeader ? 1 : 0;
            for (let i = startRow; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || row.length === 0) continue;

                const question = String(row[questionCol] || '').trim();
                const answer = String(row[answerCol] || '').trim();

                if (question) {
                    data.push({
                        question: question,
                        answer: answer || 'ë‹µì´ ì—†ìŠµë‹ˆë‹¤.',
                        index: i - startRow + 1,
                        sheet: sheetName || 'ì•Œ ìˆ˜ ì—†ìŒ'
                    });
                }
            }

            return data;
        }

        // Notification í‘œì‹œ í•¨ìˆ˜
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            // 2ì´ˆ í›„ ìë™ìœ¼ë¡œ ì‚¬ë¼ì§€ê¸°
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2000);
        }

        // ìë™ë³µì‚¬ ê¸°ëŠ¥
        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(text).then(() => {
                    showNotification('ë‹µì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
                    return true;
                }).catch(err => {
                    console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                    return false;
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showNotification('ë‹µì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
                    return Promise.resolve(true);
                } catch (err) {
                    document.body.removeChild(textArea);
                    console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                    return Promise.resolve(false);
                }
            }
        }

        // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('autoCopyCheckbox').addEventListener('change', function(e) {
            autoCopyEnabled = e.target.checked;
        });

        // ìë™ì§€ìš°ê¸° ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('autoClearCheckbox').addEventListener('change', function(e) {
            autoClearEnabled = e.target.checked;
        });

        // ì¹´ë©”ë¼ ê´€ë ¨ ë³€ìˆ˜
        let cameraStream = null;
        const cameraModal = document.getElementById('cameraModal');
        const cameraVideo = document.getElementById('cameraVideo');
        const cameraBtn = document.getElementById('cameraBtn');
        const cameraCaptureBtn = document.getElementById('cameraCaptureBtn');
        const cameraCloseBtn = document.getElementById('cameraCloseBtn');
        const cameraLoading = document.getElementById('cameraLoading');

        // ì¹´ë©”ë¼ ì—´ê¸° í•¨ìˆ˜
        async function openCamera() {
            try {
                // ì¹´ë©”ë¼ ê¶Œí•œ í™•ì¸
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('ì´ ë¸Œë¼ìš°ì €ëŠ” ì¹´ë©”ë¼ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }

                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment' // í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ 
                    } 
                });
                cameraVideo.srcObject = cameraStream;
                cameraModal.classList.add('show');
                cameraCaptureBtn.disabled = false;
            } catch (error) {
                console.error('ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:', error);
                let errorMessage = 'ì¹´ë©”ë¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage = 'ì¹´ë©”ë¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage = 'ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ê°€ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage = 'ì¹´ë©”ë¼ê°€ ë‹¤ë¥¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.';
                }
                
                alert(errorMessage);
            }
        }

        // ì¹´ë©”ë¼ ë‹«ê¸° í•¨ìˆ˜
        function closeCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            cameraVideo.srcObject = null;
            cameraModal.classList.remove('show');
            cameraLoading.style.display = 'none';
            cameraCaptureBtn.disabled = false;
        }

        // ì¹´ë©”ë¼ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        cameraBtn.addEventListener('click', function() {
            openCamera();
        });

        // ì¹´ë©”ë¼ ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        cameraCloseBtn.addEventListener('click', function() {
            closeCamera();
        });

        // ì´ë¯¸ì§€ ìº¡ì²˜ ë° OCR ì²˜ë¦¬ í•¨ìˆ˜
        async function captureAndOCR() {
            if (!cameraStream) return;

            try {
                cameraCaptureBtn.disabled = true;
                cameraLoading.style.display = 'block';

                // ë¹„ë””ì˜¤ í”„ë ˆì„ì„ ìº”ë²„ìŠ¤ì— ìº¡ì²˜
                const canvas = document.createElement('canvas');
                canvas.width = cameraVideo.videoWidth;
                canvas.height = cameraVideo.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);

                // ìº”ë²„ìŠ¤ë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜
                const imageData = canvas.toDataURL('image/png');

                // Tesseract.jsë¡œ OCR ìˆ˜í–‰ (í•œêµ­ì–´ + ì˜ì–´)
                const { data: { text } } = await Tesseract.recognize(imageData, 'kor+eng', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            cameraLoading.textContent = `OCR ì²˜ë¦¬ ì¤‘... ${Math.round(m.progress * 100)}%`;
                        }
                    }
                });

                // OCR ê²°ê³¼ ì²˜ë¦¬
                processOCRResult(text);

                // ì¹´ë©”ë¼ ë‹«ê¸°
                closeCamera();
            } catch (error) {
                console.error('OCR ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                let errorMessage = 'OCR ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                
                if (error.message && error.message.includes('language')) {
                    errorMessage = 'OCR ì–¸ì–´ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                } else if (error.message) {
                    errorMessage = 'OCR ì²˜ë¦¬ ì‹¤íŒ¨: ' + error.message;
                }
                
                alert(errorMessage);
                cameraLoading.style.display = 'none';
                cameraLoading.textContent = 'OCR ì²˜ë¦¬ ì¤‘...';
                cameraCaptureBtn.disabled = false;
            }
        }

        // OCR ê²°ê³¼ë¥¼ ê²€ìƒ‰ì°½ì— ì…ë ¥í•˜ê³  ê²€ìƒ‰ ì‹¤í–‰
        function processOCRResult(text) {
            // í…ìŠ¤íŠ¸ ì •ë¦¬ (ê³µë°± ì œê±°, ì¤„ë°”ê¿ˆ ì œê±°)
            const cleanedText = text.trim().replace(/\s+/g, ' ').replace(/\n/g, ' ');
            
            if (cleanedText && cleanedText.length > 0) {
                // ê²€ìƒ‰ì°½ì— ì…ë ¥
                searchInput.value = cleanedText;
                currentSearchTerm = cleanedText;
                clearSearchBtn.classList.add('show');
                
                // ê²€ìƒ‰ ì‹¤í–‰
                displayedCount = 0;
                performSearch();
                
                showNotification('ë¬¸ì œë¥¼ ì¸ì‹í–ˆìŠµë‹ˆë‹¤');
            } else {
                alert('í…ìŠ¤íŠ¸ë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                cameraLoading.style.display = 'none';
                cameraLoading.textContent = 'OCR ì²˜ë¦¬ ì¤‘...';
                cameraCaptureBtn.disabled = false;
            }
        }

        // ìº¡ì²˜ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        cameraCaptureBtn.addEventListener('click', function() {
            captureAndOCR();
        });

        // result-item í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì´ë²¤íŠ¸ ìœ„ì„)
        document.getElementById('results').addEventListener('click', function(e) {
            const resultItem = e.target.closest('.result-item');
            if (resultItem && autoCopyEnabled) {
                const answer = resultItem.getAttribute('data-answer');
                if (answer) {
                    // HTML ì—”í‹°í‹° ë””ì½”ë”©
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = answer;
                    const decodedAnswer = tempDiv.textContent || tempDiv.innerText || '';
                    copyToClipboard(decodedAnswer);
                }
            }
        });

        // ì¶œë ¥ ê°œìˆ˜ ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('resultLimitSelect').addEventListener('change', function(e) {
            maxResults = parseInt(e.target.value, 10);
            displayedCount = 0; // ë¦¬ì…‹
            performSearch();
        });

        // ê²€ìƒ‰ ê¸°ëŠ¥ (ë””ë°”ìš´ì‹± ì ìš©)
        document.getElementById('searchInput').addEventListener('input', function(e) {
            currentSearchTerm = e.target.value.trim();
            
            // ë””ë°”ìš´ì‹±: 300ms ì§€ì—°
            if (debounceTimer) {
                clearTimeout(debounceTimer);
            }
            
            debounceTimer = setTimeout(() => {
                displayedCount = 0; // ê²€ìƒ‰ì–´ ë³€ê²½ ì‹œ ë¦¬ì…‹
                performSearch();
            }, 300);
        });

        function performSearch(resetDisplay = false) {
            const resultsDiv = document.getElementById('results');
            
            if (!currentSearchTerm) {
                const totalCount = selectedSheet 
                    ? questionsData.filter(item => item.sheet === selectedSheet).length 
                    : questionsData.length;
                
                resultsDiv.innerHTML = 
                    `<div class="results-count">ì´ ${totalCount}ê°œì˜ ë¬¸ì œê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ${selectedSheet ? `(ì¹´í…Œê³ ë¦¬: ${selectedSheet})` : ''} ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</div>`;
                allFilteredResults = [];
                displayedCount = 0;
                return;
            }

            if (questionsData.length === 0) {
                resultsDiv.innerHTML = '<div class="no-results">ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
                allFilteredResults = [];
                displayedCount = 0;
                return;
            }

            // ê²€ìƒ‰ ìˆ˜í–‰ (ì„ íƒëœ ì¹´í…Œê³ ë¦¬ë§Œ) - ê²€ìƒ‰ì–´ê°€ ë³€ê²½ë˜ì—ˆê±°ë‚˜ ë¦¬ì…‹ ìš”ì²­ ì‹œì—ë§Œ ì¬ê²€ìƒ‰
            if (resetDisplay || displayedCount === 0) {
                const searchTerm = currentSearchTerm.toLowerCase().replace(/\s+/g, ''); // ê³µë°± ì œê±°
                allFilteredResults = questionsData.filter(item => {
                    // ì„ íƒëœ ì‹œíŠ¸ì¸ì§€ í™•ì¸
                    if (selectedSheet && item.sheet !== selectedSheet) {
                        return false;
                    }
                    // ê²€ìƒ‰ì–´ ë§¤ì¹­ (ê³µë°± ì œê±° í›„ ë¹„êµ)
                    const questionNoSpace = item.question.toLowerCase().replace(/\s+/g, '');
                    const answerNoSpace = item.answer.toLowerCase().replace(/\s+/g, '');
                    return questionNoSpace.includes(searchTerm) ||
                           answerNoSpace.includes(searchTerm);
                });
                displayedCount = 0;
            }

            if (allFilteredResults.length === 0) {
                resultsDiv.innerHTML = '<div class="no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            // í‘œì‹œí•  ê°œìˆ˜ ê³„ì‚°
            const startIndex = displayedCount;
            const toDisplay = Math.min(maxResults, allFilteredResults.length - displayedCount);
            const itemsToRender = allFilteredResults.slice(startIndex, startIndex + toDisplay);
            const isFirstLoad = startIndex === 0;

            // ê²°ê³¼ í‘œì‹œ
            let html = '';
            
            // ì²˜ìŒ ë¡œë“œí•˜ëŠ” ê²½ìš°ì—ë§Œ ì¹´ìš´íŠ¸ í‘œì‹œ
            if (isFirstLoad) {
                html = `<div class="results-count">ê²€ìƒ‰ ê²°ê³¼: ${allFilteredResults.length}ê°œ`;
                if (selectedSheet) {
                    html += ` (ì¹´í…Œê³ ë¦¬: ${selectedSheet})`;
                }
                html += `</div>`;
            }
            
            itemsToRender.forEach(item => {
                const highlightedQuestion = highlightText(item.question, currentSearchTerm);
                const highlightedAnswer = highlightText(item.answer, currentSearchTerm);
                const answerEscaped = escapeHtml(item.answer);
                
                html += `
                    <div class="result-item" data-answer="${answerEscaped.replace(/"/g, '&quot;')}">
                        <div class="result-sheet">
                            <span class="sheet-tag">${escapeHtml(item.sheet || 'ì•Œ ìˆ˜ ì—†ìŒ')}</span>
                        </div>
                        <div class="result-question">${highlightedQuestion}</div>
                        <div class="result-answer">${highlightedAnswer}</div>
                    </div>
                `;
            });

            displayedCount += toDisplay;

            // ë” ë³´ê¸° ë²„íŠ¼ ì¶”ê°€
            if (displayedCount < allFilteredResults.length) {
                html += `<button class="load-more-btn" onclick="loadMoreResults()">ë” ë³´ê¸° (${allFilteredResults.length - displayedCount}ê°œ ë‚¨ìŒ)</button>`;
            }

            // ê¸°ì¡´ ê²°ê³¼ì— ì¶”ê°€í•˜ê±°ë‚˜ ìƒˆë¡œ ë Œë”ë§
            if (isFirstLoad) {
                resultsDiv.innerHTML = html;
            } else {
                // ë” ë³´ê¸° ë²„íŠ¼ ì œê±° í›„ ì¶”ê°€
                const loadMoreBtn = resultsDiv.querySelector('.load-more-btn');
                if (loadMoreBtn) {
                    loadMoreBtn.remove();
                }
                resultsDiv.insertAdjacentHTML('beforeend', html);
            }

            // ìë™ë³µì‚¬ ê¸°ëŠ¥ (ì„±ëŠ¥ ìµœì í™”: ë¹„ë™ê¸° ì²˜ë¦¬) - ì²« ë²ˆì§¸ ê²°ê³¼ë§Œ ë³µì‚¬
            if (autoCopyEnabled && selectedSheet === "ê½ê½" && allFilteredResults.length > 0 && isFirstLoad) {
                const firstAnswer = allFilteredResults[0].answer;
                // ë Œë”ë§ ë¸”ë¡œí‚¹ ë°©ì§€ë¥¼ ìœ„í•´ ë¹„ë™ê¸° ì²˜ë¦¬
                setTimeout(() => {
                    copyToClipboard(firstAnswer).catch(() => {
                        // ë³µì‚¬ ì‹¤íŒ¨ ì‹œ ì¡°ìš©íˆ ì²˜ë¦¬ (ì‚¬ìš©ì ê²½í—˜ ë°©í•´ ìµœì†Œí™”)
                    });
                }, 0);
            }
        }

        // ë” ë³´ê¸° ë²„íŠ¼ í•¨ìˆ˜
        function loadMoreResults() {
            performSearch(false);
        }

        // í…ìŠ¤íŠ¸ í•˜ì´ë¼ì´íŠ¸
        function highlightText(text, searchTerm) {
            if (!searchTerm) return escapeHtml(text);
            
            const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
            return escapeHtml(text).replace(regex, '<span class="highlight">$1</span>');
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ì •ê·œì‹ ì´ìŠ¤ì¼€ì´í”„
        function escapeRegex(text) {
            return text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // ì¹´í…Œê³ ë¦¬ í•„í„° UI ìƒì„±
        function createCategoryFilters() {
            const categorySelect = document.getElementById('categorySelect');
            const categorySection = document.getElementById('categorySection');
            
            categorySelect.innerHTML = '';
            
            // ê¸°ë³¸ ì„ íƒê°’ì´ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ì‹œíŠ¸ ì„ íƒ
            if (!selectedSheet && allSheetNames.length > 0) {
                selectedSheet = allSheetNames[0];
            }
            
            // ì˜µì…˜ ì¶”ê°€
            allSheetNames.forEach(sheetName => {
                const option = document.createElement('option');
                option.value = sheetName;
                option.textContent = sheetName;
                if (selectedSheet === sheetName) {
                    option.selected = true;
                }
                categorySelect.appendChild(option);
            });
            
            // ë“œë¡­ë‹¤ìš´ í™œì„±í™”
            categorySelect.disabled = false;
            categorySection.classList.add('active');
            
            // ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            categorySelect.onchange = function(e) {
                selectCategory(e.target.value);
            };
        }

        // ì¹´í…Œê³ ë¦¬ ì„ íƒ (ë‹¨ì¼ ì„ íƒ)
        function selectCategory(sheetName) {
            selectedSheet = sheetName;
            displayedCount = 0; // ë¦¬ì…‹
            // ê²€ìƒ‰ ë‹¤ì‹œ ìˆ˜í–‰
            performSearch(true);
        }
    </script>
</body>
</html>

